var Ee=(p=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(p,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):p)(function(p){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+p+'" is not supported')});import xe from"fastify";import we from"@fastify/cors";import{readFileSync as ke,existsSync as Te}from"fs";import{join as ye}from"path";import{config as Ae}from"dotenv";var Oe=ye(__dirname,"..","..",".."),fe=class{config={};options;constructor(e={jsonPath:"./config.json"}){this.options={envPath:e.envPath||".env",jsonPath:e.jsonPath,useEnvFile:!1,useJsonFile:e.useJsonFile!==!1,useEnvironmentVariables:e.useEnvironmentVariables!==!1,...e},this.loadConfig()}loadConfig(){this.options.initialConfig&&(this.config={...this.config,...this.options.initialConfig}),this.options.useEnvFile&&this.loadEnvConfig(),this.options.useJsonFile&&this.options.jsonPath&&this.loadJsonConfig(),this.config.LOG_FILE&&(process.env.LOG_FILE=this.config.LOG_FILE),this.config.LOG&&(process.env.LOG=this.config.LOG)}loadJsonConfig(){if(!this.options.jsonPath)return;let e=this.isAbsolutePath(this.options.jsonPath)?this.options.jsonPath:ye(Oe,this.options.jsonPath);if(Te(e))try{let t=ke(e,"utf-8"),n=JSON.parse(t);this.config={...this.config,...n},console.log(`Loaded JSON config from: ${e}`)}catch(t){console.warn(`Failed to load JSON config from ${e}:`,t)}else console.warn(`JSON config file not found: ${e}`)}loadEnvConfig(){let e=this.isAbsolutePath(this.options.envPath)?this.options.envPath:ye(Oe,this.options.envPath);if(Te(e))try{let t=Ae({path:e});t.parsed&&(this.config={...this.config,...this.parseEnvConfig(t.parsed)})}catch(t){console.warn(`Failed to load .env config from ${e}:`,t)}}loadEnvironmentVariables(){let e=this.parseEnvConfig(process.env);this.config={...this.config,...e}}parseEnvConfig(e){let t={};return Object.assign(t,e),t}isAbsolutePath(e){return e.startsWith("/")||e.includes(":")}get(e,t){let n=this.config[e];return n!==void 0?n:t}getAll(){return{...this.config}}getHttpsProxy(){return this.get("HTTPS_PROXY")||this.get("https_proxy")||this.get("httpsProxy")||this.get("PROXY_URL")}has(e){return this.config[e]!==void 0}set(e,t){this.config[e]=t}reload(){this.config={},this.loadConfig()}getConfigSummary(){let e=[];return this.options.initialConfig&&e.push("Initial Config"),this.options.useJsonFile&&this.options.jsonPath&&e.push(`JSON: ${this.options.jsonPath}`),this.options.useEnvFile&&e.push(`ENV: ${this.options.envPath}`),this.options.useEnvironmentVariables&&e.push("Environment Variables"),`Config sources: ${e.join(", ")}`}};import Pe from"node:fs";function i(...p){if(console.log(...p),!(process.env.LOG==="true"||!0))return;let n=`[${new Date().toISOString()}] ${Array.isArray(p)?p.map(s=>typeof s=="object"?JSON.stringify(s):String(s)).join(" "):""}
`,o=process.env.LOG_FILE||"app.log";Pe.appendFileSync(o,n,"utf8")}function V(p,e=500,t="internal_error",n="api_error"){let o=new Error(p);return o.statusCode=e,o.code=t,o.type=n,o}async function $e(p,e,t){e.log.error(p);let n=p.statusCode||500,o={error:{message:p.message||"Internal Server Error",type:p.type||"api_error",code:p.code||"internal_error"}};return t.code(n).send(o)}import{ProxyAgent as be}from"undici";function ae(p,e,t){let n=new Headers({"Content-Type":"application/json"});t.headers&&Object.entries(t.headers).forEach(([c,r])=>{n.set(c,r)});let o,s=AbortSignal.timeout(t.TIMEOUT??60*1e3*60);if(t.signal){let c=new AbortController,r=()=>c.abort();t.signal.addEventListener("abort",r),s.addEventListener("abort",r),o=c.signal}else o=s;let l={method:"POST",headers:n,body:JSON.stringify(e),signal:o};return t.httpsProxy&&(l.dispatcher=new be(new URL(t.httpsProxy).toString())),fetch(typeof p=="string"?p:p.toString(),l)}var Ne=async p=>{p.get("/",async(t,n)=>({message:"LLMs API",version:"1.0.0"})),p.get("/health",async(t,n)=>({status:"ok",timestamp:new Date().toISOString()}));let e=p._server.transformerService.getTransformersWithEndpoint();for(let{name:t,transformer:n}of e)n.endPoint&&p.post(n.endPoint,async(o,s)=>{let l=o.body,c=o.provider,r=p._server.providerService.getProvider(c);if(!r)throw V(`Provider '${c}' not found`,404,"provider_not_found");let a=l,d={};if(typeof n.transformRequestOut=="function"){let f=n.transformRequestOut(l);f.body?(a=f.body,d=f.config||{}):a=f}if(r.transformer?.use?.length)for(let f of r.transformer.use){let R=p._server.transformerService.getTransformer(f);if(!R||typeof R.transformRequestIn!="function")continue;let y=R.transformRequestIn(a,r);y.body?(a=y.body,d={...d,...y.config}):a=y}if(r.transformer?.[o.body.model]?.use?.length)for(let f of r.transformer[o.body.model].use){let R=p._server.transformerService.getTransformer(f);!R||typeof R.transformRequestIn!="function"||(a=R.transformRequestIn(a,r))}let u=d.url||new URL(r.baseUrl),m=await ae(u,a,{httpsProxy:p._server.configService.getHttpsProxy(),...d,headers:{Authorization:`Bearer ${r.apiKey}`,...d?.headers||{}}});if(!m.ok){let f=await m.text();throw i(`Error response from ${u}: ${m.status} ${m.statusText}`),V(`Error from provider: ${f}`,m.status,"provider_response_error")}let h=m;if(r.transformer?.use?.length)for(let f of r.transformer.use){let R=p._server.transformerService.getTransformer(f);!R||typeof R.transformResponseOut!="function"||(h=await R.transformResponseOut(h))}if(r.transformer?.[o.body.model]?.use?.length)for(let f of r.transformer[o.body.model].use){let R=p._server.transformerService.getTransformer(f);!R||typeof R.transformResponseOut!="function"||(h=await R.transformResponseOut(h))}return n.transformResponseIn&&(h=await n.transformResponseIn(h)),h.ok||s.code(h.status),l?.stream===!0?(s.header("Content-Type","text/event-stream"),s.header("Cache-Control","no-cache"),s.header("Connection","keep-alive"),s.send(h.body)):h.json()});p.post("/providers",{schema:{body:{type:"object",properties:{id:{type:"string"},name:{type:"string"},type:{type:"string",enum:["openai","anthropic"]},baseUrl:{type:"string"},apiKey:{type:"string"},models:{type:"array",items:{type:"string"}}},required:["id","name","type","baseUrl","apiKey","models"]}}},async(t,n)=>{let{name:o,type:s,baseUrl:l,apiKey:c,models:r}=t.body;if(!o?.trim())throw V("Provider name is required",400,"invalid_request");if(!l||!Ie(l))throw V("Valid base URL is required",400,"invalid_request");if(!c?.trim())throw V("API key is required",400,"invalid_request");if(!r||!Array.isArray(r)||r.length===0)throw V("At least one model is required",400,"invalid_request");if(p._server.providerService.getProvider(id))throw V(`Provider with ID '${id}' already exists`,400,"provider_exists");return p._server.providerService.registerProvider(t.body)}),p.get("/providers",async(t,n)=>p._server.providerService.getProviders()),p.get("/providers/:id",{schema:{params:{type:"object",properties:{id:{type:"string"}},required:["id"]}}},async(t,n)=>{let o=p._server.providerService.getProvider(t.params.id);return o||n.code(404).send({error:"Provider not found"})}),p.put("/providers/:id",{schema:{params:{type:"object",properties:{id:{type:"string"}},required:["id"]},body:{type:"object",properties:{name:{type:"string"},type:{type:"string",enum:["openai","anthropic"]},baseUrl:{type:"string"},apiKey:{type:"string"},models:{type:"array",items:{type:"string"}},enabled:{type:"boolean"}}}}},async(t,n)=>{let o=p._server.providerService.updateProvider(t.params.id,t.body);return o||n.code(404).send({error:"Provider not found"})}),p.delete("/providers/:id",{schema:{params:{type:"object",properties:{id:{type:"string"}},required:["id"]}}},async(t,n)=>p._server.providerService.deleteProvider(t.params.id)?{message:"Provider deleted successfully"}:n.code(404).send({error:"Provider not found"})),p.patch("/providers/:id/toggle",{schema:{params:{type:"object",properties:{id:{type:"string"}},required:["id"]},body:{type:"object",properties:{enabled:{type:"boolean"}},required:["enabled"]}}},async(t,n)=>p._server.providerService.toggleProvider(t.params.id,t.body.enabled)?{message:`Provider ${t.body.enabled?"enabled":"disabled"} successfully`}:n.code(404).send({error:"Provider not found"}))};function Ie(p){try{return new URL(p),!0}catch{return!1}}var ue=class{constructor(e){this.providerService=e}registerProvider(e){return this.providerService.registerProvider(e)}getProviders(){return this.providerService.getProviders()}getProvider(e){return this.providerService.getProvider(e)}updateProvider(e,t){return this.providerService.updateProvider(e,t)}deleteProvider(e){return this.providerService.deleteProvider(e)}toggleProvider(e,t){return this.providerService.toggleProvider(e,t)}resolveRoute(e){let t=this.providerService.resolveModelRoute(e);if(!t)throw new Error(`Model ${e} not found. Available models: ${this.getAvailableModelNames().join(", ")}`);return t}async getAvailableModels(){return{object:"list",data:this.providerService.getAvailableModels().flatMap(t=>t.models.map(n=>({id:n,object:"model",provider:t.provider,created:Math.floor(Date.now()/1e3),owned_by:t.provider})))}}getAvailableModelNames(){return this.providerService.getModelRoutes().map(e=>e.fullModel)}getModelRoutes(){return this.providerService.getModelRoutes()}};var pe=class{constructor(e){this.configService=e;this.initializeCustomProviders()}providers=new Map;modelRoutes=new Map;initializeCustomProviders(){let e=this.configService.get("providers");if(e&&Array.isArray(e)){this.initializeFromProvidersArray(e);return}}initializeFromProvidersArray(e){e.forEach(t=>{try{if(!t.name||!t.api_base_url||!t.api_key)return;this.registerProvider({name:t.name,baseUrl:t.api_base_url,apiKey:t.api_key,models:t.models||[],transformer:this.parseTransformerConfig(t.transformer)||{}}),i(`${t.name} provider registered`)}catch(n){i(`${t.name} provider registered error: ${n}`)}})}registerProvider(e){let t={...e};return this.providers.set(t.name,t),e.models.forEach(n=>{let o=`${t.name},${n}`,s={provider:t.name,model:n,fullModel:o};this.modelRoutes.set(o,s),this.modelRoutes.has(n)||this.modelRoutes.set(n,s)}),t}getProviders(){return Array.from(this.providers.values())}getProvider(e){return this.providers.get(e)}updateProvider(e,t){let n=this.providers.get(e);if(!n)return null;let o={...n,...t,updatedAt:new Date};return this.providers.set(e,o),t.models&&(n.models.forEach(s=>{let l=`${n.id},${s}`;this.modelRoutes.delete(l),this.modelRoutes.delete(s)}),t.models.forEach(s=>{let l=`${n.id},${s}`,c={providerId:n.id,model:s,fullModel:l};this.modelRoutes.set(l,c),this.modelRoutes.has(s)||this.modelRoutes.set(s,c)})),o}deleteProvider(e){let t=this.providers.get(e);return t?(t.models.forEach(n=>{let o=`${t.id},${n}`;this.modelRoutes.delete(o),this.modelRoutes.delete(n)}),this.providers.delete(e),!0):!1}toggleProvider(e,t){let n=this.providers.get(e);return n?(n.enabled=t,n.updatedAt=new Date,!0):!1}resolveModelRoute(e){let t=this.modelRoutes.get(e);if(!t)return null;let n=this.providers.get(t.providerId);return!n||!n.enabled?null:{provider:n,originalModel:e,targetModel:t.model}}getAvailableModelNames(){let e=[];return this.providers.forEach(t=>{t.enabled&&t.models.forEach(n=>{e.push(n),e.push(`${t.id},${n}`)})}),e}getModelRoutes(){return Array.from(this.modelRoutes.values())}parseTransformerConfig(e){return e?Array.isArray(e)?e.reduce((t,n)=>{if(Array.isArray(n)){let[o,s={}]=n;t[o]=s}else t[n]={};return t},{}):e:{}}async getAvailableModels(){let e=[];return this.providers.forEach(t=>{t.enabled&&t.models.forEach(n=>{e.push({id:n,object:"model",created:Math.floor(t.createdAt.getTime()/1e3),owned_by:t.name,provider:t.name}),e.push({id:`${t.id},${n}`,object:"model",created:Math.floor(t.createdAt.getTime()/1e3),owned_by:t.name,provider:t.id})})}),{object:"list",data:e}}};var ce=class{name="Anthropic";endPoint="/v1/messages";transformRequestOut(e){i(`\u{1F680} [MODEL_ROUTING] Anthropic Request - Model: ${e.model}, Messages: ${e.messages?.length||0}`),e.model?.includes("gemini-2.5-flash-lite-preview-06-17")?i(`\u2705 [BACKGROUND_MODEL] \u68C0\u6D4B\u5230\u80CC\u666F\u6A21\u578B: ${e.model}`):i(`\u{1F7E1} [OTHER_MODEL] \u5176\u4ED6\u6A21\u578B: ${e.model}`);let t=[];if(e.system){if(typeof e.system=="string")t.push({role:"system",content:[{type:"text",text:e.system,cache_control:{type:"ephemeral"}}]});else if(Array.isArray(e.system)){let s=e.system.filter(l=>l.type==="text"&&l.text).map(l=>({type:"text",text:l.text,cache_control:{type:"ephemeral"}}));t.push({role:"system",content:s})}}return JSON.parse(JSON.stringify(e.messages||[]))?.forEach((s,l)=>{if(s.role==="user"||s.role==="assistant"){if(typeof s.content=="string")t.push({role:s.role,content:[{type:"text",text:s.content,cache_control:{type:"ephemeral"}}]});else if(Array.isArray(s.content)){if(s.role==="user"){let c=s.content.filter(a=>a.type==="tool_result"&&a.tool_use_id);c.length&&c.forEach((a,d)=>{let u={role:"tool",name:a.name||a.tool_use_id||"unknown",content:typeof a.content=="string"?a.content:JSON.stringify(a.content),tool_call_id:a.tool_use_id,cache_control:a.cache_control};t.push(u)});let r=s.content.filter(a=>a.type==="text"&&a.text).map(a=>({type:"text",text:a.text,cache_control:{type:"ephemeral"}}));r.length&&t.push({role:"user",content:r})}else if(s.role==="assistant"){let c=s.content.filter(a=>a.type==="text"&&a.text).map(a=>({type:"text",text:a.text,cache_control:{type:"ephemeral"}}));c.length&&t.push(...c.map(a=>({role:"assistant",content:a.text})));let r=s.content.filter(a=>a.type==="tool_use"&&a.id);r.length&&t.push({role:"assistant",content:null,tool_calls:r.map(a=>({id:a.id,type:"function",function:{name:a.name,arguments:JSON.stringify(a.input||{})}}))})}return}}}),{messages:t,model:e.model,max_tokens:e.max_tokens,temperature:e.temperature,stream:e.stream,tools:e.tools?this.convertAnthropicToolsToUnified(e.tools):void 0,tool_choice:e.tool_choice}}async transformResponseIn(e){let t=e.headers.get("Content-Type")?.includes("text/event-stream");if(i(`\u{1F4E1} [RESPONSE_TYPE] \u54CD\u5E94\u7C7B\u578B: ${t?"\u6D41\u5F0F":"\u975E\u6D41\u5F0F"}`),i(`\u{1F4E1} [RESPONSE_HEADERS] \u54CD\u5E94\u5934: Content-Type=${e.headers.get("Content-Type")}`),t){if(!e.body)throw new Error("Stream response body is null");let n=await this.convertOpenAIStreamToAnthropic(e.body);return new Response(n,{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}})}else{let n=await e.json(),o=this.convertOpenAIResponseToAnthropic(n);return new Response(JSON.stringify(o),{headers:{"Content-Type":"application/json"}})}}convertAnthropicToolsToUnified(e){return e.map(t=>({type:"function",function:{name:t.name,description:t.description||"",parameters:t.input_schema}}))}async convertOpenAIStreamToAnthropic(e){return new ReadableStream({async start(n){let o=new TextEncoder,s=`msg_${Date.now()}`,l="unknown",c=!1,r=!1,a=!1,d=new Map,u=new Map,m=0,h=0,g=0,f=!1,R=!1,y=0,T="",b={input_tokens:0,output_tokens:0},O=N=>{if(!f)try{n.enqueue(N)}catch(C){if(C instanceof TypeError&&C.message.includes("Controller is already closed"))f=!0;else throw i(`send data error: ${C.message}`),C}},J=()=>{if(!f)try{n.close(),f=!0}catch(N){if(N instanceof TypeError&&N.message.includes("Controller is already closed"))f=!0;else throw N}},_=null;try{_=e.getReader();let N=new TextDecoder,C="";for(;!f;){let{done:E,value:S}=await _.read();if(E)break;C+=N.decode(S,{stream:!0});let L=C.split(`
`);C=L.pop()||"";for(let k of L){if(f||a)break;if(!k.startsWith("data: "))continue;let K=k.slice(6);if(K!=="[DONE]")try{if(!K||K.trim()==="")continue;let I=JSON.parse(K);if(I.usage&&(b={input_tokens:I.usage.prompt_tokens||0,output_tokens:I.usage.completion_tokens||0}),m++,m===1&&(i(`\u{1F4CA} [FIRST_CHUNK] \u6A21\u578B: ${I.model||"unknown"}, ID: ${I.id||"unknown"}`),I.model?.includes("gemini-2.5-flash-lite-preview-06-17")&&i("\u{1F3AF} [BACKGROUND_STREAM_START] \u80CC\u666F\u6A21\u578B\u6D41\u5F0F\u54CD\u5E94\u5F00\u59CB")),l=I.model||l,I.model&&I.model!==l&&(i(`\u{1F504} [MODEL_RESPONSE] \u54CD\u5E94\u6A21\u578B: ${I.model}`),I.model.includes("gemini-2.5-flash-lite-preview-06-17")&&i(`\u2705 [BACKGROUND_MODEL_RESPONSE] \u80CC\u666F\u6A21\u578B\u54CD\u5E94\u786E\u8BA4: ${I.model}`)),!c&&!f&&!a){c=!0;let M={type:"message_start",message:{id:s,type:"message",role:"assistant",content:[],model:l,stop_reason:null,stop_sequence:null,usage:{input_tokens:1,output_tokens:1}}};O(o.encode(`event: message_start
data: ${JSON.stringify(M)}

`))}let x=I.choices?.[0];if(!x){l?.includes("gemini-2.5-flash-lite-preview-06-17")&&i(`\u26A0\uFE0F [BACKGROUND_NO_CHOICE] \u80CC\u666F\u6A21\u578B\u54CD\u5E94\u6CA1\u6709\u9009\u62E9: ${JSON.stringify(I).substring(0,200)}...`);continue}if(x?.delta?.thinking&&!f&&!a){if(!R){let M={type:"content_block_start",index:y,content_block:{type:"thinking",thinking:""}};O(o.encode(`event: content_block_start
data: ${JSON.stringify(M)}

`)),R=!0}if(x.delta.thinking.signature){let M={type:"content_block_delta",index:y,delta:{type:"signature_delta",signature:x.delta.thinking.signature}};O(o.encode(`event: content_block_delta
data: ${JSON.stringify(M)}

`));let A={type:"content_block_stop",index:y};O(o.encode(`event: content_block_stop
data: ${JSON.stringify(A)}

`)),y++}else if(x.delta.thinking.content){let M={type:"content_block_delta",index:y,delta:{type:"thinking_delta",thinking:x.delta.thinking.content||""}};O(o.encode(`event: content_block_delta
data: ${JSON.stringify(M)}

`))}}if(x?.delta?.content&&!f&&!a){if(h++,T+=x.delta.content,!r&&!a){r=!0;let M={type:"content_block_start",index:y,content_block:{type:"text",text:""}};O(o.encode(`event: content_block_start
data: ${JSON.stringify(M)}

`))}if(!f&&!a){let M={type:"content_block_delta",index:y,delta:{type:"text_delta",text:x.delta.content}};O(o.encode(`event: content_block_delta
data: ${JSON.stringify(M)}

`))}}if(x?.delta?.tool_calls&&!f&&!a){g++;let M=new Set;for(let A of x.delta.tool_calls){if(f)break;let U=A.index??0;if(M.has(U))continue;if(M.add(U),!u.has(U)){let G=r?u.size+1:u.size;if(G!==0){i("content_block_stop2");let _e={type:"content_block_stop",index:y};O(o.encode(`event: content_block_stop
data: ${JSON.stringify(_e)}

`)),y++}u.set(U,G);let H=A.id||`call_${Date.now()}_${U}`,D=A.function?.name||`tool_${U}`,j={type:"content_block_start",index:y,content_block:{type:"tool_use",id:H,name:D,input:{}}};O(o.encode(`event: content_block_start
data: ${JSON.stringify(j)}

`));let z={id:H,name:D,arguments:"",contentBlockIndex:G};d.set(U,z)}else if(A.id&&A.function?.name){let G=d.get(U);G.id.startsWith("call_")&&G.name.startsWith("tool_")&&(G.id=A.id,G.name=A.function.name)}if(A.function?.arguments&&!f&&!a){if(u.get(U)===void 0)continue;let H=d.get(U);if(H){H.arguments+=A.function.arguments;try{let D=H.arguments.trim();if(D.startsWith("{")&&D.endsWith("}"))try{JSON.parse(D)}catch(j){i("Tool call index:",U,"error",j.message)}}catch(D){i("Tool call index:",U,"error",D.message)}}try{let D={type:"content_block_delta",index:y,delta:{type:"input_json_delta",partial_json:A.function.arguments}};O(o.encode(`event: content_block_delta
data: ${JSON.stringify(D)}

`))}catch{try{let j=A.function.arguments.replace(/[\x00-\x1F\x7F-\x9F]/g,"").replace(/\\/g,"\\\\").replace(/"/g,'\\"'),z={type:"content_block_delta",index:y,delta:{type:"input_json_delta",partial_json:j}};O(o.encode(`event: content_block_delta
data: ${JSON.stringify(z)}

`))}catch(j){console.error(j)}}}}}if(x?.finish_reason&&!f&&!a){if(a=!0,l?.includes("gemini-2.5-flash-lite-preview-06-17")&&i(`\u{1F3AF} [BACKGROUND_FINISH_REASON] \u80CC\u666F\u6A21\u578B\u5B8C\u6210\u539F\u56E0: ${x.finish_reason}`),i(`\u{1F3C1} [STREAM_END] \u603B\u5757\u6570: ${m}, \u5185\u5BB9\u5757: ${h}, \u5DE5\u5177\u5757: ${g}, \u6A21\u578B: ${l}`),l?.includes("gemini-2.5-flash-lite-preview-06-17")&&i("\u{1F3AF} [BACKGROUND_STREAM_END] \u80CC\u666F\u6A21\u578B\u6D41\u5F0F\u54CD\u5E94\u7ED3\u675F"),h===0&&g===0&&console.error("Warning: No content in the stream response!"),(r||g>0)&&!f){i("content_block_stop hasTextContentStarted");let A={type:"content_block_stop",index:y};O(o.encode(`event: content_block_stop
data: ${JSON.stringify(A)}

`))}if(!f){let ie={type:"message_delta",delta:{stop_reason:{stop:"end_turn",length:"max_tokens",tool_calls:"tool_use",content_filter:"stop_sequence"}[x.finish_reason]||"end_turn",stop_sequence:null},usage:b};O(o.encode(`event: message_delta
data: ${JSON.stringify(ie)}

`))}if(!f){let A={type:"message_stop"};O(o.encode(`event: message_stop
data: ${JSON.stringify(A)}

`))}let M={type:"message",role:"assistant",content:[],stop_reason:x.finish_reason==="stop"?"end_turn":x.finish_reason==="length"?"max_tokens":x.finish_reason==="tool_calls"?"tool_use":x.finish_reason==="content_filter"?"stop_sequence":"end_turn",stop_sequence:null,usage:b};h>0&&M.content.push({type:"text",text:T}),g>0&&d.forEach(A=>{M.content.push({type:"tool_use",id:A.id,name:A.name,input:A.arguments?JSON.parse(A.arguments):{}})}),i(`\u{1F3AF} [FINAL_RESPONSE] Conversion complete, final Anthropic response: ${JSON.stringify(M,null,2)}`),l?.includes("gemini-2.5-flash-lite-preview-06-17")&&i("\u{1F3AF} [BACKGROUND_FINAL_RESPONSE] \u80CC\u666F\u6A21\u578B\u6700\u7EC8\u54CD\u5E94\u5B8C\u6210");break}}catch(I){l?.includes("gemini-2.5-flash-lite-preview-06-17")?(i(`\u274C [BACKGROUND_PARSE_ERROR] \u80CC\u666F\u6A21\u578B\u54CD\u5E94\u89E3\u6790\u9519\u8BEF: ${I.message}`),i(`\u274C [BACKGROUND_PARSE_ERROR] \u95EE\u9898\u6570\u636E: ${K.substring(0,200)}...`)):i(`parseError: ${I.name} message: ${I.message} data: ${K.substring(0,100)}...`)}}}l?.includes("gemini-2.5-flash-lite-preview-06-17")&&i(`\u{1F3C1} [BACKGROUND_STREAM_LOOP_END] \u80CC\u666F\u6A21\u578B\u6D41\u5F0F\u54CD\u5E94\u4E3B\u5FAA\u73AF\u7ED3\u675F\uFF0C\u603B\u5757\u6570: ${m}`),J()}catch(N){if(!f)try{l?.includes("gemini-2.5-flash-lite-preview-06-17")&&i(`\u274C [BACKGROUND_STREAM_ERROR] \u80CC\u666F\u6A21\u578B\u6D41\u5F0F\u54CD\u5E94\u9519\u8BEF: ${N.message}`),n.error(N)}catch(C){console.error(C)}}finally{if(_)try{_.releaseLock()}catch(N){console.error(N)}}},cancel(n){i("cancle stream:",n),i(`\u274C [STREAM_CANCEL] \u6D41\u5F0F\u54CD\u5E94\u88AB\u53D6\u6D88: ${n}`)}})}convertOpenAIResponseToAnthropic(e){let t=e.choices[0];if(!t)throw new Error("No choices found in OpenAI response");let n=[];t.message.content&&n.push({type:"text",text:t.message.content}),t.message.tool_calls&&t.message.tool_calls.length>0&&t.message.tool_calls.forEach(s=>{let l={};try{let c=s.function.arguments||"{}";typeof c=="object"?l=c:typeof c=="string"&&(l=JSON.parse(c))}catch{l={text:s.function.arguments||""}}n.push({type:"tool_use",id:s.id,name:s.function.name,input:l})});let o={id:e.id,type:"message",role:"assistant",model:e.model,content:n,stop_reason:t.finish_reason==="stop"?"end_turn":t.finish_reason==="length"?"max_tokens":t.finish_reason==="tool_calls"?"tool_use":t.finish_reason==="content_filter"?"stop_sequence":"end_turn",stop_sequence:null,usage:{input_tokens:e.usage?.prompt_tokens||0,output_tokens:e.usage?.completion_tokens||0}};return i(`\u{1F3AF} [FINAL_RESPONSE] Conversion complete, final Anthropic response: ${JSON.stringify(o,null,2)}`),o}};var X=class{name="gemini";endPoint="/v1beta/models/:modelAndAction";transformRequestIn(e,t){return{body:{contents:e.messages.map(n=>{let o;n.role==="assistant"?o="model":(["user","system","tool"].includes(n.role),o="user");let s=[];return typeof n.content=="string"?s.push({text:n.content}):Array.isArray(n.content)&&s.push(...n.content.map(l=>{if(l.type==="text")return{text:l.text||""}})),Array.isArray(n.tool_calls)&&s.push(...n.tool_calls.map(l=>({functionCall:{id:l.id||`tool_${Math.random().toString(36).substring(2,15)}`,name:l.function.name,args:JSON.parse(l.function.arguments||"{}")}}))),{role:o,parts:s}}),tools:[{functionDeclarations:e.tools?.map(n=>(delete n.function.parameters?.$schema,delete n.function.parameters?.additionalProperties,n.function.parameters?.properties&&Object.keys(n.function.parameters.properties).forEach(o=>{delete n.function.parameters.properties[o].$schema,delete n.function.parameters.properties[o].additionalProperties,n.function.parameters.properties[o].items&&typeof n.function.parameters.properties[o].items=="object"&&(delete n.function.parameters.properties[o].items.$schema,delete n.function.parameters.properties[o].items.additionalProperties),n.function.parameters.properties[o].type==="string"&&(["enum","date-time"].includes(n.function.parameters.properties[o].format)||delete n.function.parameters.properties[o].format)}),{name:n.function.name,description:n.function.description,parameters:n.function.parameters}))||[]}]},config:{url:new URL(`./${e.model}:${e.stream?"streamGenerateContent?alt=sse":"generateContent"}`,t.baseUrl),headers:{"x-goog-api-key":t.apiKey,Authorization:void 0}}}}transformRequestOut(e){let t=e.contents,n=e.tools,o=e.model,s=e.max_tokens,l=e.temperature,c=e.stream,r=e.tool_choice,a={messages:[],model:o,max_tokens:s,temperature:l,stream:c,tool_choice:r};return Array.isArray(t)&&t.forEach(d=>{typeof d=="string"?a.messages.push({role:"user",content:d}):typeof d.text=="string"?a.messages.push({role:"user",content:d.text||null}):d.role==="user"?a.messages.push({role:"user",content:d?.parts?.map(u=>({type:"text",text:u.text||""}))||[]}):d.role==="model"&&a.messages.push({role:"assistant",content:d?.parts?.map(u=>({type:"text",text:u.text||""}))||[]})}),Array.isArray(n)&&(a.tools=[],n.forEach(d=>{Array.isArray(d.functionDeclarations)&&d.functionDeclarations.forEach(u=>{a.tools.push({type:"function",function:{name:u.name,description:u.description,parameters:u.parameters}})})})),a}async transformResponseOut(e){if(e.headers.get("Content-Type")?.includes("application/json")){let t=await e.json(),n=t.candidates[0].content.parts.filter(s=>s.functionCall).map(s=>({id:s.functionCall?.id||`tool_${Math.random().toString(36).substring(2,15)}`,type:"function",function:{name:s.functionCall?.name,arguments:JSON.stringify(s.functionCall?.args||{})}})),o={id:t.responseId,choices:[{finish_reason:t.candidates[0].finishReason?.toLowerCase()||null,index:0,message:{content:t.candidates[0].content.parts.filter(s=>s.text).map(s=>s.text).join(`
`),role:"assistant",tool_calls:n.length>0?n:void 0}}],created:parseInt(new Date().getTime()/1e3+"",10),model:t.modelVersion,object:"chat.completion",usage:{completion_tokens:t.usageMetadata.candidatesTokenCount,prompt_tokens:t.usageMetadata.promptTokenCount,total_tokens:t.usageMetadata.totalTokenCount}};return new Response(JSON.stringify(o),{status:e.status,statusText:e.statusText,headers:e.headers})}else if(e.headers.get("Content-Type")?.includes("stream")){if(!e.body)return e;let t=new TextDecoder,n=new TextEncoder,o=new ReadableStream({async start(s){let l=e.body.getReader();try{for(;;){let{done:c,value:r}=await l.read();if(c)break;let a=t.decode(r,{stream:!0});if(a.startsWith("data: "))a=a.slice(6).trim();else break;a=JSON.parse(a);let d=a.candidates[0].content.parts.filter(m=>m.functionCall).map(m=>({id:m.functionCall?.id||`tool_${Math.random().toString(36).substring(2,15)}`,type:"function",function:{name:m.functionCall?.name,arguments:JSON.stringify(m.functionCall?.args||{})}})),u={choices:[{delta:{role:"assistant",content:a.candidates[0].content.parts.filter(m=>m.text).map(m=>m.text).join(`
`),tool_calls:d.length>0?d:void 0},finish_reason:a.candidates[0].finishReason?.toLowerCase()||null,index:a.candidates[0].index||d.length>0?1:0,logprobs:null}],created:parseInt(new Date().getTime()/1e3+"",10),id:a.responseId||"",model:a.modelVersion||"",object:"chat.completion.chunk",system_fingerprint:"fp_a49d71b8a1"};a.usageMetadata&&(u.usage={completion_tokens:a.usageMetadata.candidatesTokenCount,prompt_tokens:a.usageMetadata.promptTokenCount,total_tokens:a.usageMetadata.totalTokenCount}),s.enqueue(n.encode(`data: ${JSON.stringify(u)}

`))}}catch(c){s.error(c)}finally{s.close()}}});return new Response(o,{status:e.status,statusText:e.statusText,headers:e.headers})}return e}};var Q=class{name="gemini-pro";transformRequestIn(e,t){return{body:{contents:e.messages.map(n=>{let o;n.role==="assistant"?o="model":(["user","system","tool"].includes(n.role),o="user");let s=[];return typeof n.content=="string"?s.push({text:n.content}):Array.isArray(n.content)&&s.push(...n.content.map(l=>l.type==="text"?{text:l.text||""}:{text:""}).filter(l=>l.text!=="")),Array.isArray(n.tool_calls)&&s.push(...n.tool_calls.map(l=>{let c={};try{typeof l.function.arguments=="string"?c=JSON.parse(l.function.arguments||"{}"):typeof l.function.arguments=="object"&&(c=l.function.arguments||{})}catch(r){i(`\u26A0\uFE0F [GEMINI_TOOL_ARGS_PARSE_ERROR] \u5DE5\u5177\u53C2\u6570\u89E3\u6790\u5931\u8D25: ${r}`),c={}}return{functionCall:{id:l.id||`tool_${Math.random().toString(36).substring(2,15)}`,name:l.function.name,args:c}}})),{role:o,parts:s}}),tools:e.tools&&e.tools.length>0?[{functionDeclarations:e.tools.map(n=>{let o={name:n.function.name,description:n.function.description};n.function.parameters&&(n.function.parameters.properties||n.function.parameters.required)&&(o.parameters={type:"object",properties:{}},n.function.parameters.properties&&Object.keys(n.function.parameters.properties).forEach(l=>{let c=n.function.parameters.properties[l],r={type:c.type};c.description&&(r.description=c.description),c.enum&&(r.enum=c.enum),c.items&&typeof c.items=="object"&&(r.items={type:c.items.type},c.items.description&&(r.items.description=c.items.description)),o.parameters.properties[l]=r}),n.function.parameters.required&&Array.isArray(n.function.parameters.required)&&n.function.parameters.required.length>0&&(o.parameters.required=n.function.parameters.required));let s=o.parameters?Object.keys(o.parameters.properties||{}).length:0;return i(`\u{1F527} [GEMINI_TOOL_DEF] \u5DE5\u5177\u5B9A\u4E49: ${o.name}, \u53C2\u6570\u6570\u91CF: ${s}, \u683C\u5F0F: ${JSON.stringify(o).substring(0,200)}...`),o})||[]}]:[]},config:{url:new URL(`./${e.model}:${e.stream?"streamGenerateContent?alt=sse":"generateContent"}`,t.baseUrl),headers:{"x-goog-api-key":t.apiKey,Authorization:void 0}}}}transformRequestOut(e){let t=e.contents||[],n=e.tools||[],o=e.model,s=e.max_tokens,l=e.temperature,c=e.stream,r=e.tool_choice,a={messages:[],model:o,max_tokens:s,temperature:l,stream:c,tool_choice:r};return t.forEach(d=>{let u={role:d.role==="model"?"assistant":"user",content:d.parts.filter(h=>h.text).map(h=>({type:"text",text:h.text||""}))},m=d.parts.filter(h=>h.functionCall).map(h=>({id:h.functionCall?.id||`tool_${Math.random().toString(36).substring(2,15)}`,type:"function",function:{name:h.functionCall?.name||"",arguments:JSON.stringify(h.functionCall?.args||{})}}));m.length>0&&(u.tool_calls=m),a.messages.push(u)}),n.length>0&&(a.tools=[],n.forEach(d=>{d.functionDeclarations&&d.functionDeclarations.forEach(u=>{a.tools.push({type:"function",function:{name:u.name,description:u.description,parameters:{type:"object",properties:u.parameters.properties||{},required:u.parameters.required||[],additionalProperties:u.parameters.additionalProperties}}})})})),a}async transformResponseOut(e){return e.headers.get("Content-Type")?.includes("application/json")?this.handleNonStreamResponse(e):e.headers.get("Content-Type")?.includes("stream")?this.handleStreamResponse(e):e}async handleNonStreamResponse(e){if(!e.ok){let r=await e.text();throw i(`\u274C [GEMINI_ERROR] Gemini API \u9519\u8BEF\u54CD\u5E94: ${e.status} ${e.statusText}`),i(`\u274C [GEMINI_ERROR] \u9519\u8BEF\u8BE6\u60C5: ${r}`),new Error(`Gemini API error: ${e.status} ${e.statusText} - ${r}`)}let n=await e.clone().text();i(`\u{1F50D} [GEMINI_RAW_RESPONSE] \u670D\u52A1\u5668\u539F\u59CB\u54CD\u5E94: ${n}`);let o=JSON.parse(n);if(o.error)throw i(`\u274C [GEMINI_ERROR] Gemini API \u8FD4\u56DE\u9519\u8BEF: ${JSON.stringify(o.error)}`),new Error(`Gemini API error: ${o.error.message||"Unknown error"}`);if(!o.candidates||!o.candidates[0])throw new Error("Invalid Gemini response format");let s=o.candidates[0];if(s.finishReason==="MALFORMED_FUNCTION_CALL"){i("\u26A0\uFE0F [GEMINI_MALFORMED_FUNCTION] \u68C0\u6D4B\u5230\u5DE5\u5177\u8C03\u7528\u683C\u5F0F\u9519\u8BEF");let r={id:o.responseId||`chatcmpl-${Date.now()}`,choices:[{finish_reason:"stop",index:0,message:{content:"\u62B1\u6B49\uFF0C\u5DE5\u5177\u8C03\u7528\u683C\u5F0F\u6709\u8BEF\uFF0C\u65E0\u6CD5\u6267\u884C\u3002",role:"assistant"}}],created:Math.floor(Date.now()/1e3),model:o.modelVersion||"gemini-pro",object:"chat.completion",usage:o.usageMetadata?{completion_tokens:o.usageMetadata.candidatesTokenCount,prompt_tokens:o.usageMetadata.promptTokenCount,total_tokens:o.usageMetadata.totalTokenCount}:void 0};return new Response(JSON.stringify(r),{status:200,statusText:"OK",headers:e.headers})}let l=s.content.parts.filter(r=>r.functionCall).map(r=>{let a=r.functionCall?.args||{},d="";try{typeof a=="string"?d=a:d=JSON.stringify(a)}catch(u){i(`\u26A0\uFE0F [GEMINI_TOOL_ARGS_ERROR] \u5DE5\u5177\u53C2\u6570\u5E8F\u5217\u5316\u5931\u8D25: ${u}`),d="{}"}return{id:r.functionCall?.id||`tool_${Math.random().toString(36).substring(2,15)}`,type:"function",function:{name:r.functionCall?.name||"",arguments:d}}}),c={id:o.responseId||`chatcmpl-${Date.now()}`,choices:[{finish_reason:s.finishReason?.toLowerCase()||null,index:0,message:{content:s.content.parts.filter(r=>r.text).map(r=>r.text).join(""),role:"assistant",tool_calls:l.length>0?l:void 0}}],created:Math.floor(Date.now()/1e3),model:o.modelVersion||"gemini-pro",object:"chat.completion",usage:o.usageMetadata?{completion_tokens:o.usageMetadata.candidatesTokenCount,prompt_tokens:o.usageMetadata.promptTokenCount,total_tokens:o.usageMetadata.totalTokenCount}:void 0};return new Response(JSON.stringify(c),{status:e.status,statusText:e.statusText,headers:e.headers})}handleStreamResponse(e){if(!e.body)return e;let t=new TextDecoder,n=new TextEncoder,o=new ReadableStream({async start(s){let l=e.body.getReader(),c="",r=null;try{for(;;){let{done:a,value:d}=await l.read();if(a){c.trim()&&i(`\u26A0\uFE0F [GEMINI_STREAM_WARN] \u6D41\u7ED3\u675F\u65F6\u7F13\u51B2\u533A\u4E2D\u4ECD\u6709\u672A\u5904\u7406\u6570\u636E: ${c.substring(0,200)}...`),i("\u{1F3C1} [GEMINI_STREAM_END] \u6D41\u771F\u6B63\u7ED3\u675F\uFF0C\u53D1\u9001\u6700\u7EC8\u5757");let m={choices:[{delta:{role:"assistant",content:null},finish_reason:"stop",index:0,logprobs:null}],created:parseInt(new Date().getTime()/1e3+"",10),id:"final",model:"gemini-pro",object:"chat.completion.chunk",system_fingerprint:"fp_a49d71b8a1"};r&&(m.usage={completion_tokens:r.candidatesTokenCount||0,prompt_tokens:r.promptTokenCount||0,total_tokens:r.totalTokenCount||0});let h=`data: ${JSON.stringify(m)}

`;i(`\u{1F3C1} [GEMINI_FINAL_CHUNK] \u6700\u7EC8\u5757\u5185\u5BB9: ${h}`),s.enqueue(n.encode(h));break}c+=t.decode(d,{stream:!0});let u;for(;(u=c.indexOf(`

`))!==-1;){let m=c.slice(0,u);if(c=c.slice(u+2),!m.startsWith("data: "))continue;let h=m.slice(6).trim();if(!h)continue;let g;try{g=JSON.parse(h),g.usageMetadata&&(r=g.usageMetadata)}catch(T){i(`\u26A0\uFE0F [GEMINI_CHUNK_PARSE_ERROR] \u5757\u89E3\u6790\u5931\u8D25: ${T}, \u5757\u5185\u5BB9: ${h.substring(0,200)}...`);continue}if(g.candidates?.[0]?.finishReason==="MALFORMED_FUNCTION_CALL"){i("\u26A0\uFE0F [GEMINI_MALFORMED_FUNCTION_STREAM] \u68C0\u6D4B\u5230\u6D41\u5F0F\u54CD\u5E94\u4E2D\u7684\u5DE5\u5177\u8C03\u7528\u683C\u5F0F\u9519\u8BEF");let T={choices:[{delta:{role:"assistant",content:"\u62B1\u6B49\uFF0C\u5DE5\u5177\u8C03\u7528\u683C\u5F0F\u6709\u8BEF\uFF0C\u65E0\u6CD5\u6267\u884C\u3002"},finish_reason:"stop",index:0,logprobs:null}],created:parseInt(new Date().getTime()/1e3+"",10),id:"",model:"",object:"chat.completion.chunk",system_fingerprint:"fp_a49d71b8a1"};s.enqueue(n.encode(`data: ${JSON.stringify(T)}

`));break}let f=g.candidates[0].content.parts.filter(T=>T.functionCall).map(T=>{let b=T.functionCall?.args||{},O="";try{typeof b=="string"?O=b:O=JSON.stringify(b)}catch(J){i(`\u26A0\uFE0F [GEMINI_TOOL_ARGS_ERROR] \u5DE5\u5177\u53C2\u6570\u5E8F\u5217\u5316\u5931\u8D25: ${J}`),O="{}"}return i(`\u{1F527} [GEMINI_TOOL_CALL] \u5DE5\u5177: ${T.functionCall?.name}, \u53C2\u6570\u957F\u5EA6: ${O.length}`),{id:T.functionCall?.id||`tool_${Math.random().toString(36).substring(2,15)}`,type:"function",function:{name:T.functionCall?.name,arguments:O}}}),R=g.candidates[0].content.parts.filter(T=>T.text).map(T=>T.text).join("");R&&i(`\u{1F4DD} [GEMINI_CONTENT] content:"${R}"`),f.length>0&&i(`\u{1F527} [GEMINI_TOOL_CALLS] \u5DE5\u5177\u8C03\u7528\u6570\u91CF: ${f.length}`);let y={choices:[{delta:{role:"assistant",content:R||null,tool_calls:f.length>0?f:void 0},finish_reason:null,index:g.candidates[0].index||f.length>0?1:0,logprobs:null}],created:parseInt(new Date().getTime()/1e3+"",10),id:g.responseId||"",model:g.modelVersion||"",object:"chat.completion.chunk",system_fingerprint:"fp_a49d71b8a1"};g.usageMetadata&&(y.usage={completion_tokens:g.usageMetadata.candidatesTokenCount,prompt_tokens:g.usageMetadata.promptTokenCount,total_tokens:g.usageMetadata.totalTokenCount}),s.enqueue(n.encode(`data: ${JSON.stringify(y)}

`))}}}catch(a){i(`\u274C [GEMINI_STREAM_ERROR] \u6D41\u5904\u7406\u9519\u8BEF: ${a}`);try{let d={choices:[{delta:{role:"assistant",content:"\u62B1\u6B49\uFF0C\u5904\u7406\u54CD\u5E94\u65F6\u51FA\u73B0\u9519\u8BEF\u3002"},finish_reason:"stop",index:0,logprobs:null}],created:parseInt(new Date().getTime()/1e3+"",10),id:"",model:"",object:"chat.completion.chunk",system_fingerprint:"fp_a49d71b8a1"};s.enqueue(n.encode(`data: ${JSON.stringify(d)}

`))}catch(d){i(`\u274C [GEMINI_FINAL_ERROR] \u53D1\u9001\u9519\u8BEF\u6D88\u606F\u5931\u8D25: ${d}`)}}finally{s.close()}}});return new Response(o,{status:e.status,statusText:e.statusText,headers:e.headers})}};var Z=class{name="deepseek";transformRequestIn(e){return e.max_tokens&&e.max_tokens>8192&&(e.max_tokens=8192),e}async transformResponseOut(e){if(e.headers.get("Content-Type")?.includes("application/json")){let t=await e.json();return new Response(JSON.stringify(t),{status:e.status,statusText:e.statusText,headers:e.headers})}else if(e.headers.get("Content-Type")?.includes("stream")){if(!e.body)return e;let t=new TextDecoder,n=new TextEncoder,o="",s=!1,l=new ReadableStream({async start(c){let r=e.body.getReader();try{for(;;){let{done:a,value:d}=await r.read();if(a)break;let m=t.decode(d,{stream:!0}).split(`
`);for(let h of m)if(h.startsWith("data: ")&&h.trim()!=="data: [DONE]")try{let g=JSON.parse(h.slice(6));if(g.choices?.[0]?.delta?.reasoning_content){o+=g.choices[0].delta.reasoning_content;let f={...g,choices:[{...g.choices[0],delta:{...g.choices[0].delta,thinking:{content:g.choices[0].delta.reasoning_content}}}]};delete f.choices[0].delta.reasoning_content;let R=`data: ${JSON.stringify(f)}

`;c.enqueue(n.encode(R));continue}if(g.choices?.[0]?.delta?.content&&o&&!s){s=!0;let f=Date.now().toString(),R={...g,choices:[{...g.choices[0],delta:{...g.choices[0].delta,content:null,thinking:{content:o,signature:f}}}]};delete R.choices[0].delta.reasoning_content;let y=`data: ${JSON.stringify(R)}

`;c.enqueue(n.encode(y))}if(g.choices[0]?.delta?.reasoning_content&&delete g.choices[0].delta.reasoning_content,g.choices?.[0]?.delta&&Object.keys(g.choices[0].delta).length>0){s&&g.choices[0].index++;let f=`data: ${JSON.stringify(g)}

`;c.enqueue(n.encode(f))}}catch{c.enqueue(n.encode(h+`
`))}else c.enqueue(n.encode(h+`
`))}}catch(a){c.error(a)}finally{try{r.releaseLock()}catch(a){console.error("Error releasing reader lock:",a)}c.close()}}});return new Response(l,{status:e.status,statusText:e.statusText,headers:{"Content-Type":e.headers.get("Content-Type")||"text/plain","Cache-Control":"no-cache",Connection:"keep-alive"}})}return e}};var le=class{name="tooluse";transformRequestIn(e){return e.messages.push({role:"system",content:"<system-reminder>Tool mode is active. The user expects you to proactively execute the most suitable tool to help complete the task. \nBefore invoking a tool, you must carefully evaluate whether it matches the current task. If no available tool is appropriate for the task, you MUST call the `ExitTool` to exit tool mode \u2014 this is the only valid way to terminate tool mode.\nAlways prioritize completing the user's task effectively and efficiently by using tools whenever appropriate.</system-reminder>"}),e.tools?.length&&(e.tool_choice="required",e.tools.unshift({type:"function",function:{name:"ExitTool",description:`Use this tool when you are in tool mode and have completed the task. This is the only valid way to exit tool mode.
IMPORTANT: Before using this tool, ensure that none of the available tools are applicable to the current task. You must evaluate all available options \u2014 only if no suitable tool can help you complete the task should you use ExitTool to terminate tool mode.
Examples:
1. Task: "Use a tool to summarize this document" \u2014 Do not use ExitTool if a summarization tool is available.
2. Task: "What\u2019s the weather today?" \u2014 If no tool is available to answer, use ExitTool after reasoning that none can fulfill the task.`,parameters:{type:"object",properties:{response:{type:"string",description:"Your response will be forwarded to the user exactly as returned \u2014 the tool will not modify or post-process it in any way."}},required:["response"]}}})),e}async transformResponseOut(e){if(e.headers.get("Content-Type")?.includes("application/json")){let t=await e.json();if(t?.choices[0]?.message.tool_calls?.length&&t?.choices[0]?.message.tool_calls[0]?.function?.name==="ExitTool"){let n=t?.choices[0]?.message.tool_calls[0],o=JSON.parse(n.function.arguments||"{}");t.choices[0].message.content=o.response||"",delete t.choices[0].message.tool_calls}return new Response(JSON.stringify(t),{status:e.status,statusText:e.statusText,headers:e.headers})}else if(e.headers.get("Content-Type")?.includes("stream")){if(!e.body)return e;let t=new TextDecoder,n=new TextEncoder,o=-1,s="",l=new ReadableStream({async start(c){let r=e.body.getReader();try{for(;;){let{done:a,value:d}=await r.read();if(a)break;let m=t.decode(d,{stream:!0}).split(`
`);for(let h of m)if(h.startsWith("data: ")&&h.trim()!=="data: [DONE]")try{let g=JSON.parse(h.slice(6));if(g.choices[0]?.delta?.tool_calls?.length){let f=g.choices[0].delta.tool_calls[0];if(f.function?.name==="ExitTool"){o=f.index;continue}else if(o>-1&&f.index===o&&f.function.arguments){s+=f.function.arguments;try{let R=JSON.parse(s);g.choices=[{delta:{role:"assistant",content:R.response||""}}];let y=`data: ${JSON.stringify(g)}

`;c.enqueue(n.encode(y))}catch{}continue}}if(g.choices?.[0]?.delta&&Object.keys(g.choices[0].delta).length>0){let f=`data: ${JSON.stringify(g)}

`;c.enqueue(n.encode(f))}}catch{c.enqueue(n.encode(h+`
`))}else c.enqueue(n.encode(h+`
`))}}catch(a){c.error(a)}finally{try{r.releaseLock()}catch(a){console.error("Error releasing reader lock:",a)}c.close()}}});return new Response(l,{status:e.status,statusText:e.statusText,headers:{"Content-Type":e.headers.get("Content-Type")||"text/plain","Cache-Control":"no-cache",Connection:"keep-alive"}})}return e}};var ee=class{name="openrouter";transformRequestIn(e){return e.model.includes("claude")||e.messages.forEach(t=>{Array.isArray(t.content)?t.content.forEach(n=>{n.cache_control&&delete n.cache_control}):t.cache_control&&delete t.cache_control}),e}async transformResponseOut(e){if(e.headers.get("Content-Type")?.includes("application/json")){let t=await e.json();return new Response(JSON.stringify(t),{status:e.status,statusText:e.statusText,headers:e.headers})}else if(e.headers.get("Content-Type")?.includes("stream")){if(!e.body)return e;let t=new TextDecoder,n=new TextEncoder,o=!1,s="",l=!1,c=new ReadableStream({async start(r){let a=e.body.getReader();try{for(;;){let{done:d,value:u}=await a.read();if(d)break;let h=t.decode(u,{stream:!0}).split(`
`);for(let g of h)if(g.startsWith("data: ")&&g.trim()!=="data: [DONE]")try{let f=JSON.parse(g.slice(6));if(f.choices[0]?.delta?.content&&!o&&(o=!0),f.choices?.[0]?.delta?.reasoning){s+=f.choices[0].delta.reasoning;let y={...f,choices:[{...f.choices[0],delta:{...f.choices[0].delta,thinking:{content:f.choices[0].delta.reasoning}}}]};delete y.choices[0].delta.reasoning;let T=`data: ${JSON.stringify(y)}

`;r.enqueue(n.encode(T));continue}if(f.choices?.[0]?.delta?.content&&s&&!l){l=!0;let y=Date.now().toString(),T={...f,choices:[{...f.choices[0],delta:{...f.choices[0].delta,content:null,thinking:{content:s,signature:y}}}]};delete T.choices[0].delta.reasoning;let b=`data: ${JSON.stringify(T)}

`;r.enqueue(n.encode(b))}f.choices[0]?.delta?.reasoning&&delete f.choices[0].delta.reasoning,f.choices[0]?.delta?.tool_calls?.length&&o&&(f.choices[0].index+=1);let R=`data: ${JSON.stringify(f)}

`;r.enqueue(n.encode(R))}catch{r.enqueue(n.encode(g+`
`))}else r.enqueue(n.encode(g+`
`))}}catch(d){r.error(d)}finally{try{a.releaseLock()}catch(d){console.error("Error releasing reader lock:",d)}r.close()}}});return new Response(c,{status:e.status,statusText:e.statusText,headers:{"Content-Type":e.headers.get("Content-Type")||"text/plain","Cache-Control":"no-cache",Connection:"keep-alive"}})}return e}};var te=class{name="openai";endPoint="/v1/chat/completions";transformRequestOut(e){return i("[OpenAI-Transformer] \u6536\u5230\u539F\u59CB\u8ACB\u6C42:",JSON.stringify(e,null,2)),e}async transformResponseOut(e){let t=e.clone();try{let n=await t.json();i("[OpenAI-Transformer] \u767C\u9001\u6700\u7D42\u97FF\u61C9:",JSON.stringify(n,null,2))}catch(n){i("[OpenAI-Transformer] \u7121\u6CD5\u89E3\u6790\u6700\u7D42\u97FF\u61C9\u70BA JSON:",n);let o=await e.clone().text();i("[OpenAI-Transformer] \u6700\u7D42\u97FF\u61C9 (\u6587\u672C):",o)}return e}};var me=class{static cleanTools(e){return!e||!Array.isArray(e)?e:e.map(n=>this.cleanSingleTool(n))}static cleanSingleTool(e){let t=JSON.parse(JSON.stringify(e));return t.function?.parameters&&this.cleanJsonSchema(t.function.parameters),t}static cleanJsonSchema(e){!e||typeof e!="object"||(e.properties&&typeof e.properties=="object"&&Object.keys(e.properties).forEach(t=>{this.cleanSchemaProperty(e.properties[t])}),e.items&&this.cleanSchemaProperty(e.items),["anyOf","allOf","oneOf"].forEach(t=>{Array.isArray(e[t])&&e[t].forEach(n=>this.cleanJsonSchema(n))}),delete e.$schema,delete e.additionalProperties)}static cleanSchemaProperty(e){!e||typeof e!="object"||(e.const!==void 0&&(e.enum=[e.const],delete e.const),this.cleanJsonSchema(e))}static validateCleanedTools(e){try{if(!Array.isArray(e))return!1;for(let t of e){if(!t.function?.name||!t.function?.parameters)return!1;if(this.hasIncompatibleFields(t.function.parameters))return i(`\u26A0\uFE0F \u5DE5\u5177 ${t.function.name} \u4ECD\u5305\u542B\u4E0D\u517C\u5BB9\u5B57\u6BB5`),!1}return!0}catch(t){return i(`\u274C \u5DE5\u5177\u9A8C\u8BC1\u5931\u8D25: ${t}`),!1}}static hasIncompatibleFields(e){if(!e||typeof e!="object")return!1;let t=["const","$schema"];for(let n of t)if(e[n]!==void 0)return!0;for(let n in e)if(typeof e[n]=="object"&&e[n]!==null&&this.hasIncompatibleFields(e[n]))return!0;return!1}};var ve="v18.1",Me={MAX_REASONING_LENGTH:5e4,MAX_CHUNKS_PER_REQUEST:1e3,DEBUG_MODE:process.env.NEWAPI_DEBUG==="true",LOG_RAW_DATA:process.env.NEWAPI_LOG_RAW==="true"},v=`[NewAPI-${ve}]`,$={ENTRY:`${v} \u{1F4E5} [ENTRY]`,EXIT:`${v} \u{1F4E4} [EXIT]`,PROCESSING:`${v} \u2699\uFE0F [PROCESSING]`,MODEL_DETECT:`${v} \u{1F50D} [MODEL-DETECT]`,MODEL_THINKING:`${v} \u{1F9E0} [MODEL-THINKING]`,MSG_ANALYSIS:`${v} \u{1F4CA} [MSG-ANALYSIS]`,MSG_TRANSFORM:`${v} \u{1F504} [MSG-TRANSFORM]`,MSG_FIX:`${v} \u{1F527} [MSG-FIX]`,MSG_VALIDATE:`${v} \u2705 [MSG-VALIDATE]`,DEBUG_DETAIL:`${v} \u{1F50D} [DEBUG]`,DEBUG_CONTENT:`${v} \u{1F4DD} [DEBUG-CONTENT]`,DEBUG_STRUCTURE:`${v} \u{1F3D7}\uFE0F [DEBUG-STRUCTURE]`,SUCCESS:`${v} \u2705 [SUCCESS]`,WARNING:`${v} \u26A0\uFE0F [WARNING]`,ERROR:`${v} \u274C [ERROR]`,INFO:`${v} \u2139\uFE0F [INFO]`,TOOL_CLEAN:`${v} \u{1F9F9} [TOOL-CLEAN]`,TOOL_CHOICE:`${v} \u{1F3AF} [TOOL-CHOICE]`,STATS:`${v} \u{1F4C8} [STATS]`,SUMMARY:`${v} \u{1F4CB} [SUMMARY]`,RESPONSE_IN:`${v} \u{1F4E8} [RESPONSE-IN]`,RESPONSE_OUT:`${v} \u{1F4E4} [RESPONSE-OUT]`,STREAM_PROCESSING:`${v} \u{1F30A} [STREAM]`,REASONING_CONVERT:`${v} \u{1F9E0} [REASONING-CONVERT]`,SAFETY_CHECK:`${v} \u{1F6E1}\uFE0F [SAFETY]`,DATA_FLOW:`${v} \u{1F4CA} [DATA-FLOW]`,COMPLETION_DETECT:`${v} \u{1F3AF} [COMPLETION-DETECT]`,SIGNATURE_GEN:`${v} \u{1F510} [SIGNATURE]`,INDEX_HANDLE:`${v} \u{1F4CD} [INDEX]`,CONTENT_TRACK:`${v} \u{1F4DD} [CONTENT-TRACK]`,THINKING_TRACK:`${v} \u{1F9E0} [THINKING-TRACK]`,TEXT_TRACK:`${v} \u{1F4C4} [TEXT-TRACK]`},ne=class{name="newapi";version=`${ve} - \u7CBE\u7B80\u7A33\u5B9A\u7248`;transformRequestIn(e,t){i(`${$.ENTRY} \u5F00\u59CB\u5904\u7406\u8BF7\u6C42 - \u6A21\u578B: ${e.model}`),e.messages&&i(`${$.MSG_ANALYSIS} \u5206\u6790\u6D88\u606F\u7ED3\u6784 - \u6D88\u606F\u6570\u91CF: ${e.messages.length}`);let n={...e};i(`${$.PROCESSING} \u5F00\u59CB\u6A21\u578B\u68C0\u6D4B\u548C\u53C2\u6570\u4FEE\u590D`),this.isThinkingModel(n.model)&&(n=this.fixThinkingModeParameters(n)),n.tools&&n.tools.length>0&&(i(`${$.TOOL_CLEAN} \u5F00\u59CB\u6E05\u7406\u5DE5\u5177\u5B9A\u4E49 - \u5DE5\u5177\u6570\u91CF: ${n.tools.length}`),n.tools=me.cleanTools(n.tools),i(`${$.TOOL_CLEAN} \u5DE5\u5177\u6E05\u7406\u5B8C\u6210`));let o=n.thinking?"Yes":"No",s=n.tools?n.tools.length:0;return i(`${$.SUMMARY} \u8F6C\u6362\u5B8C\u6210 - thinking\u6A21\u5F0F: ${o}, \u5DE5\u5177\u6570\u91CF: ${s}`),i(`${$.EXIT} \u8BF7\u6C42\u5904\u7406\u5B8C\u6210`),n}async transformResponseOut(e){if(i(`${$.RESPONSE_IN} \u5F00\u59CB\u5904\u7406\u54CD\u5E94\u8F6C\u6362`),e.headers.get("Content-Type")?.includes("text/event-stream")){if(i(`${$.STREAM_PROCESSING} \u5904\u7406\u6D41\u5F0F\u54CD\u5E94`),!e.body)return i(`${$.WARNING} \u54CD\u5E94\u4F53\u4E3A\u7A7A\uFF0C\u76F4\u63A5\u8FD4\u56DE`),e;let t=new TextDecoder,n=new TextEncoder,o=new ReadableStream({async start(s){let l=0,c="",r=!1,a=!1,d=e.body.getReader();try{for(;;){let{done:u,value:m}=await d.read();if(u){i(`${$.DATA_FLOW} \u6D41\u5F0F\u54CD\u5E94\u5B8C\u6210 - \u603Bchunks: ${l}, reasoning: ${c.length>0?"Yes":"No"}, text: ${a?"Yes":"No"}`);break}let g=t.decode(m,{stream:!0}).split(`
`);for(let f of g)if(f.startsWith("data: ")&&f.trim()!=="data: [DONE]")try{let R=JSON.parse(f.slice(6));if(l++,l>Me.MAX_CHUNKS_PER_REQUEST){i(`${$.WARNING} chunk\u6570\u91CF\u8D85\u9650\uFF0C\u8DF3\u8FC7`);continue}let y=R.choices?.[0]?.delta;y&&(y.reasoning_content&&(c+=y.reasoning_content,i(`${$.THINKING_TRACK} \u63A8\u7406\u5185\u5BB9\u7D2F\u79EF - \u5F53\u524D\u957F\u5EA6: ${c.length}, \u65B0\u589E: ${y.reasoning_content.length}`)),y.content&&!a&&(a=!0),y.reasoning_content&&(i(`${$.REASONING_CONVERT} \u8F6C\u6362reasoning_content \u2192 delta.thinking`),y.thinking={content:y.reasoning_content},delete y.reasoning_content));let T=`data: ${JSON.stringify(R)}

`;s.enqueue(n.encode(T))}catch(R){i(`${$.ERROR} JSON\u89E3\u6790\u5931\u8D25: ${R.message}`),s.enqueue(n.encode(f+`
`))}else s.enqueue(n.encode(f+`
`))}}catch(u){i(`${$.ERROR} \u6D41\u5F0F\u54CD\u5E94\u5904\u7406\u9519\u8BEF: ${u.message}`);try{s.error(u)}catch{s.close()}}finally{try{d.releaseLock(),s.close()}catch(u){i(`${$.WARNING} \u6E05\u7406\u65F6\u51FA\u9519: ${u.message}`)}}}});return new Response(o,{status:e.status,statusText:e.statusText,headers:e.headers})}else{i(`${$.RESPONSE_IN} \u5904\u7406\u975E\u6D41\u5F0F\u54CD\u5E94`);let t=await e.json();if(t.choices?.[0]?.message?.reasoning_content){i(`${$.REASONING_CONVERT} \u68C0\u6D4B\u5230reasoning_content\uFF0C\u8F6C\u6362\u4E3Athinking\u683C\u5F0F`);let n=t.choices[0].message.reasoning_content;t.choices[0].message.thinking={content:n}}return new Response(JSON.stringify(t),{status:e.status,statusText:e.statusText,headers:e.headers})}}fixThinkingModeParameters(e){i(`${$.MODEL_THINKING} \u5F00\u59CB\u4FEE\u590Dthinking\u6A21\u5F0F\u53C2\u6570`);let t={...e};return t.thinking={type:"enabled",budget_tokens:1e4},i(`${$.MODEL_THINKING} \u5DF2\u6DFB\u52A0thinking\u53C2\u6570: type=enabled, budget_tokens=10000`),t.messages&&t.messages.length>0&&(t.messages=this.fixMessagesForThinking(t.messages)),t.tool_choice&&typeof t.tool_choice=="object"&&(t.tool_choice.type==="any"||t.tool_choice.type==="tool")&&(i(`${$.TOOL_CHOICE} \u4FEE\u6B63tool_choice: \u4E0D\u652F\u6301thinking\u6A21\u5F0F\u7684'${t.tool_choice.type}'\uFF0C\u6539\u4E3A'auto'`),t.tool_choice="auto"),i(`${$.MODEL_THINKING} thinking\u6A21\u5F0F\u53C2\u6570\u4FEE\u590D\u5B8C\u6210`),t}fixMessagesForThinking(e){i(`${$.MSG_ANALYSIS} \u5F00\u59CB\u5206\u6790\u6D88\u606F\u683C\u5F0F - \u603B\u6D88\u606F\u6570: ${e.length}`);let t={};e.forEach((s,l)=>{t[s.role]=(t[s.role]||0)+1}),i(`${$.STATS} \u6D88\u606F\u7EDF\u8BA1: ${Object.entries(t).map(([s,l])=>`${s}=${l}`).join(", ")}`);let n=[];for(let s=0;s<e.length;s++)e[s].role==="assistant"&&n.push(s);if(n.length===0)return i(`${$.INFO} \u672A\u627E\u5230assistant\u6D88\u606F\uFF0C\u65E0\u9700\u4FEE\u590Dthinking\u5757`),e;i(`${$.MSG_FIX} \u627E\u5230${n.length}\u4E2Aassistant\u6D88\u606F\uFF0C\u5904\u7406\u4E2D`);let o=0;for(let s of n){let l=e[s],c=this.ensureThinkingBlock(l.content,s);c!==l.content&&(e[s]={...l,content:c},o++)}return i(`${$.SUMMARY} thinking\u5757\u4FEE\u590D\u5B8C\u6210: \u4FEE\u590D\u4E86${o}\u4E2Aassistant\u6D88\u606F`),e}ensureThinkingBlock(e,t){return!e||Array.isArray(e)&&e.length===0?(i(`${$.WARNING} assistant\u6D88\u606F[${t}] content\u4E3A\u7A7A\uFF0C\u4EC5\u6DFB\u52A0thinking\u5757`),[{type:"thinking",text:"\u6211\u6B63\u5728\u5904\u7406\u8FD9\u4E2A\u8BF7\u6C42\u3002"}]):typeof e=="string"?(i(`${$.MSG_TRANSFORM} assistant\u6D88\u606F[${t}] \u5B57\u7B26\u4E32content\u8F6C\u6362\u4E3A\u6570\u7EC4\u5E76\u6DFB\u52A0thinking\u5757`),[{type:"thinking",text:"\u8BA9\u6211\u5206\u6790\u8FD9\u4E2A\u8BF7\u6C42\u3002"},{type:"text",text:e}]):Array.isArray(e)?e.length>0&&["thinking","redacted_thinking"].includes(e[0]?.type)?e:(i(`${$.MSG_FIX} assistant\u6D88\u606F[${t}] \u7F3A\u5C11thinking\u5757\uFF0C\u6DFB\u52A0\u5230\u5F00\u5934`),[{type:"thinking",text:e.some(l=>l.type==="tool_use")?"\u6211\u9700\u8981\u4F7F\u7528\u5DE5\u5177\u6765\u5B8C\u6210\u8FD9\u4E2A\u8BF7\u6C42\u3002":"\u6211\u6B63\u5728\u5206\u6790\u8FD9\u4E2A\u8BF7\u6C42\u5E76\u51C6\u5907\u56DE\u5E94\u3002"},...e]):e}isThinkingModel(e){let t=e.includes("thinking"),n=e.includes("claude-sonnet-4-20250514")||e.includes("claude-opus-4-20250514")||e.includes("claude-3-7-sonnet"),o=e.includes("gemini-2.5-pro"),s=t||n||o;return i(`${$.MODEL_DETECT} \u6A21\u578B\u68C0\u6D4B: "${e}"`),i(`${$.MODEL_DETECT}   - \u540D\u79F0\u5305\u542Bthinking: ${t}`),i(`${$.MODEL_DETECT}   - \u662FClaude4\u6A21\u578B: ${n}`),i(`${$.MODEL_DETECT}   - \u662FGemini 2.5 Pro\u6A21\u578B: ${o}`),i(`${$.MODEL_DETECT}   - \u6700\u7EC8\u5224\u65AD: ${s?"\u542F\u7528thinking\u6A21\u5F0F":"\u4E0D\u542F\u7528thinking\u6A21\u5F0F"}`),s}transformRequestOut(e){return e}};var Ce="v1.0",B=`[Gemini-Native-${Ce}]`,P={ENTRY:`${B} \u{1F4E5} [\u5165\u53E3]`,EXIT:`${B} \u{1F4E4} [\u51FA\u53E3]`,REQ_TRANSFORM:`${B} \u{1F504} [\u8BF7\u6C42\u8F6C\u6362]`,RES_TRANSFORM:`${B} \u{1F504} [\u54CD\u5E94\u8F6C\u6362]`,STREAM_PROCESSING:`${B} \u{1F30A} [\u6D41\u5F0F\u5904\u7406]`,TOOL_CONVERT:`${B} \u{1F6E0}\uFE0F [\u5DE5\u5177\u8F6C\u6362]`,MESSAGE_CONVERT:`${B} \u{1F4AC} [\u6D88\u606F\u8F6C\u6362]`,ERROR:`${B} \u274C [\u9519\u8BEF]`,INFO:`${B} \u2139\uFE0F [\u4FE1\u606F]`,DEBUG:`${B} \u{1F50D} [\u8C03\u8BD5]`},oe=class{name="gemini-native";version=`${Ce} - \u521D\u59CB\u7248\u672C`;transformRequestIn(e,t){i(`${P.ENTRY} \u5F00\u59CB\u8F6C\u6362\u53D1\u5F80 Gemini \u7684\u8BF7\u6C42`);let n={};return n.contents=this.convertMessagesToGemini(e.messages||[]),i(`${P.MESSAGE_CONVERT} \u6D88\u606F\u8F6C\u6362\u5B8C\u6210\uFF0C\u5171 ${n.contents.length} \u6761`),e.tools&&e.tools.length>0&&(e.tools.forEach(o=>{o.function&&o.function.parameters&&Re(o.function.parameters)}),n.tools=[{functionDeclarations:e.tools.map(o=>o.function)}],i(`${P.TOOL_CONVERT} \u5DE5\u5177\u5B9A\u4E49\u8F6C\u6362\u5B8C\u6210\uFF0C\u5171 ${e.tools.length} \u4E2A\u5DE5\u5177`),e.tool_choice?(typeof e.tool_choice=="string"&&["auto","any","none"].includes(e.tool_choice)?n.tool_config={function_calling_config:{mode:e.tool_choice.toUpperCase()}}:typeof e.tool_choice=="object"&&e.tool_choice.type==="tool"&&(n.tool_config={function_calling_config:{mode:"ANY",allowed_function_names:[e.tool_choice.name]}}),i(`${P.TOOL_CONVERT} \u5DE5\u5177\u9009\u62E9\u6A21\u5F0F\u8BBE\u7F6E\u4E3A: ${JSON.stringify(n.tool_config)}`)):n.tool_config={function_calling_config:{mode:"AUTO"}}),n.generationConfig={temperature:e.temperature,maxOutputTokens:e.max_tokens,...typeof e.top_p<"u"?{topP:e.top_p}:{},...typeof e.stop<"u"?{stopSequences:e.stop}:{}},i(`${P.EXIT} Gemini \u8BF7\u6C42\u8F6C\u6362\u5B8C\u6210`),process.env.GEMINI_LOG_RAW_REQ==="true"&&i(`${P.DEBUG} \u8F6C\u6362\u540E\u7684\u8BF7\u6C42: ${JSON.stringify(n,null,2)}`),n}async transformResponseOut(e){if(i(`${P.RES_TRANSFORM} \u5F00\u59CB\u8F6C\u6362\u6765\u81EA Gemini \u7684\u54CD\u5E94 (\u5F3A\u5236\u975E\u6D41\u5F0F)`),!e.body)return i(`${P.ERROR} \u54CD\u5E94\u4F53\u4E3A\u7A7A`),new Response(JSON.stringify({error:"Empty response body"}),{status:500,headers:{"Content-Type":"application/json"}});try{let t=await e.json();process.env.GEMINI_LOG_RAW_RES==="true"&&i(`${P.DEBUG} \u539F\u59CB Gemini \u54CD\u5E94: ${JSON.stringify(t,null,2)}`);let n=this.convertGeminiChunkToUnified(t,"NON_STREAM");return i(`${P.RES_TRANSFORM} \u975E\u6D41\u5F0F\u54CD\u5E94\u8F6C\u6362\u5B8C\u6210`),new Response(JSON.stringify(n),{status:e.status,headers:{"Content-Type":"application/json"}})}catch(t){i(`${P.ERROR} \u89E3\u6790\u975E\u6D41\u5F0F\u54CD\u5E94\u5931\u8D25: ${t.message}`);let n=await e.text();return i(`${P.ERROR} \u539F\u59CB\u54CD\u5E94\u6587\u672C: ${n}`),new Response(JSON.stringify({error:`Failed to parse non-streaming response: ${t.message}`,original_response:n}),{status:500,headers:{"Content-Type":"application/json"}})}}convertMessagesToGemini(e){let t=[],n="",o=e.filter(s=>s.role==="system"?(typeof s.content=="string"?n+=`${s.content}

`:Array.isArray(s.content)&&s.content.forEach(l=>{l.type==="text"&&l.text&&(n+=`${l.text}

`)}),!1):!0);return n&&i(`${P.DEBUG} \u63D0\u53D6\u5230\u7CFB\u7EDF\u63D0\u793A\u5185\u5BB9\uFF0C\u5C06\u5408\u5E76\u5230\u9996\u4E2A\u7528\u6237\u6D88\u606F\u4E2D\u3002`),o.forEach((s,l)=>{let c,r=[],a=!1;if(s.role==="user"){c="user";let d="";o.findIndex(u=>u.role==="user")===l&&(a=!0),typeof s.content=="string"?d=s.content:Array.isArray(s.content)&&s.content.forEach(u=>{u&&u.type==="text"&&u.text&&(d+=u.text)}),a&&n&&(d=n+d,i(`${P.DEBUG} \u5DF2\u5C06\u7CFB\u7EDF\u63D0\u793A\u5408\u5E76\u5230\u7528\u6237\u6D88\u606F\u3002`)),r.push({text:d})}else if(s.role==="assistant")c="model",typeof s.content=="string"&&s.content&&r.push({text:s.content}),s.tool_calls&&s.tool_calls.forEach(d=>{try{r.push({functionCall:{name:d.function.name,args:JSON.parse(d.function.arguments||"{}")}})}catch(u){i(`${P.ERROR} \u89E3\u6790\u5DE5\u5177\u8C03\u7528\u53C2\u6570\u5931\u8D25: ${u.message}`)}});else if(s.role==="tool"||s.role==="function"){c="function";let d=s.name;if(!d){i(`${P.ERROR} tool/function \u6D88\u606F\u7F3A\u5C11 'name' \u5B57\u6BB5\uFF0C\u5DF2\u8DF3\u8FC7: ${JSON.stringify(s)}`);return}let u={};try{u=typeof s.content=="string"?JSON.parse(s.content):s.content}catch{u={content:s.content}}r.push({functionResponse:{name:d,response:u}})}else return;(r.length>0||c==="model"&&s.tool_calls)&&t.push({role:c,parts:r})}),t}createUnifiedStream(e){let t=new TextDecoder,n=new TextEncoder,o="";return new ReadableStream({start:async s=>{let l=e.getReader(),c=()=>{let r=o.split(/\r?\n/);o=r.pop()||"";for(let a of r)if(a.trim().length!==0&&(i(`${P.DEBUG} Processing line: ${a}`),a.startsWith("data:"))){let d=a.substring(5).trim();if(d==="[DONE]"){i(`${P.DEBUG} Received [DONE] marker.`);continue}try{let u=JSON.parse(d),m=this.convertGeminiChunkToUnified(u,"STREAM");if(m){let h=`data: ${JSON.stringify(m)}

`;s.enqueue(n.encode(h)),i(`${P.STREAM_PROCESSING} Enqueued chunk.`)}}catch(u){i(`${P.ERROR} JSON parse failed: ${u.message} - on line: ${d}`)}}};try{for(;;){let{done:r,value:a}=await l.read();if(r){i(`${P.STREAM_PROCESSING} Reader is done.`),o.length>0&&c();break}o+=t.decode(a,{stream:!0}),c()}}catch(r){i(`${P.ERROR} Stream reading failed: ${r.message}`),s.error(r)}finally{i(`${P.STREAM_PROCESSING} Closing controller.`),s.close()}},cancel:()=>{i(`${P.INFO} Stream was cancelled.`)}})}convertGeminiChunkToUnified(e,t){let n=e.candidates?.[0];if(!n)return t==="STREAM"?{id:"unknown",choices:[{delta:{}}]}:{id:"unknown",choices:[{message:{}}]};let o={},s=n.content?.parts||[],l=[],c="";if(s.forEach((r,a)=>{r.text&&(c+=r.text),r.functionCall&&l.push({index:a,id:r.functionCall.name,type:"function",function:{name:r.functionCall.name,arguments:JSON.stringify(r.functionCall.args||{})}})}),c&&(o.content=c),l.length>0&&(o.tool_calls=l),t==="STREAM")return{id:e.id||`chatcmpl-${Date.now()}`,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"gemini-native",choices:[{index:0,delta:o,finish_reason:n.finishReason||null}]};{let r=n.finishReason||null;return{id:e.responseId||`chatcmpl-${Date.now()}`,object:"chat.completion",created:Math.floor(Date.now()/1e3),model:e.modelVersion||"gemini-native",choices:[{index:0,message:{role:"assistant",...o},finish_reason:r?r.toLowerCase():null}],usage:this.convertUsage(e.usageMetadata)}}}convertUsage(e){return{completion_tokens:e?.candidatesTokenCount||0,prompt_tokens:e?.promptTokenCount||0,total_tokens:e?.totalTokenCount||0}}transformRequestOut(e){return e}};function Re(p){Array.isArray(p)?p.forEach(Re):p&&typeof p=="object"&&(delete p.$schema,delete p.additionalProperties,Object.values(p).forEach(Re))}var se=class p{static LOG_PREFIX="[ZjcspaceProTransformer v1.0.0]";name="zjcspace-pro";transformRequestIn(e,t){let n=p.LOG_PREFIX,o={REQUEST_OUT:`${n} \u{1F4E4} [REQUEST-OUT]`,REQUEST_BODY:`${n} \u{1F4DD} [REQUEST-BODY]`,REQUEST_HEADERS:`${n} \u{1F3F7}\uFE0F [REQUEST-HEADERS]`,STRICT_CLEAN:`${n} \u{1F9F9} [STRICT-CLEAN]`},s=["model","messages","tools","tool_choice","stream","max_tokens","temperature","top_p","n","stop","user"],l=["role","content","name","tool_calls","tool_call_id"];function c(d){return Array.isArray(d)?d.map(u=>{let m={};for(let h of l)u[h]!==void 0&&(m[h]=u[h]);return m}):[]}let r={};for(let d of s)e[d]!==void 0&&(d==="messages"?r[d]=c(e[d]):r[d]=e[d]);r.stream===void 0&&(r.stream=!0);let a={"Content-Type":"application/json",Authorization:`Bearer ${t.apiKey}`};return i(`${o.REQUEST_OUT} Building request for provider.`),{body:r,config:{url:new URL(t.baseUrl),headers:a}}}async transformResponseOut(e){let t=p.LOG_PREFIX,n={RESPONSE_IN:`${t} \u{1F4E8} [RESPONSE-IN]`,STREAM_PROCESSING:`${t} \u{1F30A} [STREAM-MANUAL]`,EVENT:`${t} \u{1F4E4} [EVENT]`,ERROR:`${t} \u274C [ERROR]`,INFO:`${t} \u2139\uFE0F [INFO]`},o={};if(e.headers.forEach((r,a)=>{o[a]=r}),i(`${n.RESPONSE_IN} Response headers: `+JSON.stringify(o)),!e.body)return i(`${n.ERROR} Response body is empty, cannot process.`),new Response("Error: Response body is empty.",{status:500});i(`${n.STREAM_PROCESSING} Response detected, starting manual stream processing...`);let s=new TextDecoder("utf-8"),l=new TextEncoder,c=new ReadableStream({async start(r){let a=e.body.getReader(),d="",u=0,m=-1;try{for(;;){let{done:h,value:g}=await a.read();if(h){if(d.trim().length>0){i(`${n.INFO} Stream ended, processing remaining buffer content:`,d);try{let y={choices:[{delta:JSON.parse(d).choices[0].message,finish_reason:"stop"}]};r.enqueue(l.encode(`data: ${JSON.stringify(y)}

`))}catch(R){i(`${n.ERROR} Failed to parse remaining buffer:`,R)}}break}d+=s.decode(g,{stream:!0});let f=0;for(;f<d.length;){let R=d[f];if(u===0&&R==="{"?(u=1,m=f):m!==-1&&(R==="{"&&u++,R==="}"&&u--),m!==-1&&u===0){let y=d.substring(m,f+1);try{let T=JSON.parse(y);i(`${n.EVENT} Successfully parsed and forwarding an independent message.`);let b={id:T.id||`chunk-${Date.now()}`,object:"chat.completion.chunk",created:T.created||Math.floor(Date.now()/1e3),model:T.model||"zjcspace-pro-model",choices:[{index:0,delta:T.choices[0].message,finish_reason:null}]};r.enqueue(l.encode(`data: ${JSON.stringify(b)}

`))}catch(T){i(`${n.ERROR} JSON parse failed, skipping chunk:`,y,T)}d=d.substring(f+1),f=-1,m=-1}f++}}}catch(h){i(`${n.ERROR} Manual stream processing exception:`,h),r.error(h)}finally{i(`${n.STREAM_PROCESSING} Manual stream processing complete, sending [DONE] signal.`),r.enqueue(l.encode(`data: [DONE]

`));try{a.releaseLock()}catch{}r.close()}}});return new Response(c,{status:e.status,statusText:e.statusText,headers:{"Content-Type":"text/event-stream; charset=utf-8","Cache-Control":"no-cache",Connection:"keep-alive"}})}};import*as Y from"fs";import*as de from"path";var re=class p{static LOG_PREFIX="[ZjcspaceTransformer v1.7.0]";name="zjcspace";logLevel="info";LOG_LEVELS={none:0,error:1,warn:2,info:3,debug:4,verbose:5};logCategories={input:!0,fieldCleanup:!0,tools:!0,messages:!0,requestBody:!0,responseProcessing:!0,streamProcessing:!0,contentAnalysis:!0,rawData:!1,chunkProcessing:!1};constructor(e){e?.logLevel&&(this.logLevel=e.logLevel),e?.logCategories&&(this.logCategories={...this.logCategories,...e.logCategories})}shouldLog(e,t){return!(this.LOG_LEVELS[e]>this.LOG_LEVELS[this.logLevel]||t&&!this.logCategories[t])}log(e,t,n){this.shouldLog(e,n)&&i(t)}persistRequestBody(e,t){try{let n=de.join(process.cwd(),"debug");Y.existsSync(n)||Y.mkdirSync(n,{recursive:!0});let o=new Date().toISOString().replace(/[:.]/g,"-"),s=`request-${t}-${o}.json`,l=de.join(n,s),c={timestamp:new Date().toISOString(),requestId:t,requestBody:e,metadata:{transformer:"ZjcspaceTransformer",version:"v1.7.0"}};Y.writeFileSync(l,JSON.stringify(c,null,2),"utf8"),i(`[ZjcspaceTransformer] \u{1F4BE} \u8BF7\u6C42\u4F53\u5DF2\u6301\u4E45\u5316\u5230: ${l}`)}catch(n){i(`[ZjcspaceTransformer] \u274C \u6301\u4E45\u5316\u8BF7\u6C42\u4F53\u5931\u8D25: ${n}`)}}persistResponseBody(e,t,n){try{let o=de.join(process.cwd(),"debug");Y.existsSync(o)||Y.mkdirSync(o,{recursive:!0});let s=new Date().toISOString().replace(/[:.]/g,"-"),l=`response-${t}-${s}.json`,c=de.join(o,l),r={timestamp:new Date().toISOString(),requestId:t,status:n,responseBody:e,metadata:{transformer:"ZjcspaceTransformer",version:"v1.7.0"}};Y.writeFileSync(c,JSON.stringify(r,null,2),"utf8"),i(`[ZjcspaceTransformer] \u{1F4BE} \u54CD\u5E94\u4F53\u5DF2\u6301\u4E45\u5316\u5230: ${c}`)}catch(o){i(`[ZjcspaceTransformer] \u274C \u6301\u4E45\u5316\u54CD\u5E94\u4F53\u5931\u8D25: ${o}`)}}transformRequestIn(e,t){let n=p.LOG_PREFIX,o={REQUEST_OUT:`${n} \u{1F4E4} [REQUEST-OUT]`,REQUEST_BODY:`${n} \u{1F4DD} [REQUEST-BODY]`,REQUEST_HEADERS:`${n} \u{1F3F7}\uFE0F [REQUEST-HEADERS]`,STRICT_CLEAN:`${n} \u{1F9F9} [STRICT-CLEAN]`,INPUT_VALIDATION:`${n} \u{1F50D} [INPUT-VALIDATION]`,FIELD_CLEANUP:`${n} \u{1F9FD} [FIELD-CLEANUP]`,TOOLS_PROCESSING:`${n} \u{1F527} [TOOLS-PROCESSING]`,MESSAGES_PROCESSING:`${n} \u{1F4AC} [MESSAGES-PROCESSING]`};this.log("info",`${o.INPUT_VALIDATION} \u5F00\u59CB\u5904\u7406\u8BF7\u6C42 - model: ${e.model}, messages\u6570\u91CF: ${e.messages?.length||0}, tools\u6570\u91CF: ${e.tools?.length||0}`,"input"),this.log("debug",`${o.INPUT_VALIDATION} provider\u4FE1\u606F - baseUrl: ${t.baseUrl}, apiKey\u957F\u5EA6: ${t.apiKey?.length||0}`,"input");let s=["model","messages","tools","tool_choice","stream","max_tokens","max_completion_tokens","temperature","top_p","n","stop","user","logprobs","top_logprobs","response_format","seed","parallel_tool_calls","web_search_options","audio","modalities","prediction","reasoning_effort","metadata","store"],l=["role","content","name","tool_calls","tool_call_id"],c=["type","function"],r=["name","description","parameters"],a=["type","properties","required","enum","description","items"],d=[],u=[];this.log("debug",`${o.FIELD_CLEANUP} \u5F00\u59CB\u5B57\u6BB5\u6E05\u7406 - \u8FFD\u8E2A\u5B57\u6BB5\u53D8\u66F4`,"fieldCleanup");function m(_,N=""){if(!_||typeof _!="object")return _;let C={};for(let E in _)a.includes(E)||d.push(N?`${N}.${E}`:E);for(let E of a)if(_[E]!==void 0)if(E==="properties"&&typeof _[E]=="object"){C.properties={};for(let S in _.properties)C.properties[S]=m(_.properties[S],N?`${N}.properties.${S}`:`properties.${S}`)}else E==="items"&&typeof _[E]=="object"?C.items=m(_.items,N?`${N}.items`:"items"):C[E]=_[E];return C.type==="array"&&!C.items&&(C.items={type:"string"},u.push(N?`${N}.items`:"items")),C}let h=_=>{if(!Array.isArray(_)){this.log("warn",`${o.TOOLS_PROCESSING} tools\u4E0D\u662F\u6570\u7EC4\uFF0C\u8DF3\u8FC7\u5904\u7406`,"tools");return}this.log("info",`${o.TOOLS_PROCESSING} \u5F00\u59CB\u5904\u7406tools - \u539F\u59CB\u6570\u91CF: ${_.length}`,"tools");let N=_.map((C,E)=>{if(C?.type==="function"&&C.function){let S=C.function,L={};for(let k in S)r.includes(k)||d.push(`tools[${E}].function.${k}`);for(let k of r)S[k]!==void 0&&(k==="parameters"?L.parameters=m(S.parameters,`tools[${E}].function.parameters`):L[k]=S[k]);return{type:"function",function:L}}}).filter(Boolean);return this.log("info",`${o.TOOLS_PROCESSING} tools\u5904\u7406\u5B8C\u6210 - \u6E05\u7406\u540E\u6570\u91CF: ${N.length}, \u79FB\u9664\u5B57\u6BB5: ${d.filter(C=>C.startsWith("tools")).join(", ")||"\u65E0"}`,"tools"),N.length>0?N:void 0},g=_=>{if(!Array.isArray(_))return this.log("warn",`${o.MESSAGES_PROCESSING} messages\u4E0D\u662F\u6570\u7EC4\uFF0C\u8FD4\u56DE\u7A7A\u6570\u7EC4`,"messages"),[];this.log("info",`${o.MESSAGES_PROCESSING} \u5F00\u59CB\u5904\u7406messages - \u539F\u59CB\u6570\u91CF: ${_.length}`,"messages");let N=E=>{if(typeof E!="string")return E;let S=E,L=E.length,k={nestedImages:0,malformedLinks:0,windowsPaths:0,excessiveLength:0,invalidUrls:0,brokenSyntax:0},K=/\[!\[([^\]]*)\]\(([^)]+)\)\]\(([^)]+)\)/g,I=E.match(K);I&&I.length>0&&(k.nestedImages=I.length,this.log("warn",`${o.MESSAGES_PROCESSING} \u68C0\u6D4B\u5230\u5D4C\u5957Markdown\u56FE\u7247\u8BED\u6CD5\uFF0C\u8FDB\u884C\u6E05\u7406: ${I.length} \u4E2A`,"messages"),S=S.replace(K,"[$1]($3)"));let x=/\[([^\]]+)\]\(([^)]*)$/gm,M=S.match(x);M&&M.length>0&&(k.malformedLinks+=M.length,this.log("warn",`${o.MESSAGES_PROCESSING} \u68C0\u6D4B\u5230\u4E0D\u5B8C\u6574\u7684Markdown\u94FE\u63A5\uFF0C\u8FDB\u884C\u4FEE\u590D: ${M.length} \u4E2A`,"messages"),S=S.replace(x,"[$1]($2)"));let A=/\[([^\]]+)\]\(([^)]+)\)/g;if(S.match(A)){let F=(S.match(/\[/g)||[]).length,q=(S.match(/\]/g)||[]).length,W=(S.match(/\(/g)||[]).length,w=(S.match(/\)/g)||[]).length;(F!==q||W!==w)&&(k.brokenSyntax=Math.abs(F-q)+Math.abs(W-w),this.log("warn",`${o.MESSAGES_PROCESSING} \u68C0\u6D4B\u5230\u4E0D\u5339\u914D\u7684\u62EC\u53F7\uFF0C\u8FDB\u884C\u4FEE\u590D: \u65B9\u62EC\u53F7\u5DEE${Math.abs(F-q)}, \u5706\u62EC\u53F7\u5DEE${Math.abs(W-w)}`,"messages"))}let ie=/\\\\/g,G=S.match(ie);G&&G.length>0&&(k.windowsPaths=G.length,this.log("info",`${o.MESSAGES_PROCESSING} \u68C0\u6D4B\u5230Windows\u8DEF\u5F84\u683C\u5F0F\uFF0C\u8FDB\u884C\u4FEE\u590D: ${G.length} \u4E2A`,"messages"),S=S.replace(ie,"/"));let H=/\[([^\]]+)\]\(([^)]+)\)/g;if(S.match(H)){let F=0;S=S.replace(H,(q,W,w)=>{if(w&&!w.startsWith("http://")&&!w.startsWith("https://")&&!w.startsWith("mailto:")&&!w.startsWith("tel:")&&!w.startsWith("#")){if(w.startsWith("/")||w.startsWith("./")||w.startsWith("../"))return q;if(w.includes(".")&&!w.includes(" ")&&!w.includes("\\"))return F++,`[${W}](https://${w})`}return q}),F>0&&(k.invalidUrls=F,this.log("info",`${o.MESSAGES_PROCESSING} \u4FEE\u590D\u65E0\u6548URL\u683C\u5F0F: ${F} \u4E2A`,"messages"))}let j=1e4;S.length>j&&(k.excessiveLength=S.length-j,this.log("warn",`${o.MESSAGES_PROCESSING} \u5185\u5BB9\u8FC7\u957F (${S.length} \u5B57\u7B26)\uFF0C\u8FDB\u884C\u622A\u65AD`,"messages"),S=S.substring(0,j)+`

[\u5185\u5BB9\u5DF2\u622A\u65AD...]`),S=S.replace(/\s+/g," ").replace(/\n\s*\n\s*\n/g,`

`);let z=/!\[([^\]]*)\]\(([^)]*)\)/g;if(S.match(z)&&(S=S.replace(z,(F,q,W)=>!q||q.trim()===""?`![\u56FE\u7247](${W})`:F)),S!==E){let F=L-S.length,q=Object.values(k).reduce((W,w)=>W+w,0);this.log("info",`${o.MESSAGES_PROCESSING} \u5185\u5BB9\u6E05\u7406\u5B8C\u6210 - \u539F\u59CB\u957F\u5EA6: ${L}, \u6E05\u7406\u540E\u957F\u5EA6: ${S.length}, \u51CF\u5C11: ${F} \u5B57\u7B26`,"messages"),q>0&&this.log("info",`${o.MESSAGES_PROCESSING} \u6E05\u7406\u7EDF\u8BA1: \u5D4C\u5957\u56FE\u7247${k.nestedImages}, \u7578\u5F62\u94FE\u63A5${k.malformedLinks}, Windows\u8DEF\u5F84${k.windowsPaths}, \u65E0\u6548URL${k.invalidUrls}, \u8BED\u6CD5\u9519\u8BEF${k.brokenSyntax}, \u8D85\u957F\u5185\u5BB9${k.excessiveLength}`,"messages")}return S},C=_.map((E,S)=>{let L={};for(let k of l)E[k]!==void 0&&(k==="content"?(typeof E.content=="string"||Array.isArray(E.content)||E.content===null&&E.tool_calls)&&(typeof E.content=="string"?L.content=N(E.content):L.content=E.content):L[k]=E[k]);return L});return this.log("info",`${o.MESSAGES_PROCESSING} messages\u5904\u7406\u5B8C\u6210 - \u6E05\u7406\u540E\u6570\u91CF: ${C.length}`,"messages"),C};function f(_){if(Array.isArray(_))return _.map(f).filter(N=>N!=null&&!(Array.isArray(N)&&N.length===0));if(typeof _=="object"&&_!==null){let N={};for(let C in _){let E=f(_[C]);E!=null&&!(Array.isArray(E)&&E.length===0)&&!(typeof E=="object"&&Object.keys(E).length===0)&&(N[C]=E)}return N}return _}this.log("info",`${o.REQUEST_BODY} \u5F00\u59CB\u6784\u5EFA\u8BF7\u6C42\u4F53`,"requestBody");let R=g(e.messages),y={model:e.model,messages:R,tools:h(e.tools??[]),tool_choice:e.tool_choice,stream:!1,max_tokens:e.max_tokens,max_completion_tokens:e.max_completion_tokens,temperature:e.temperature,top_p:e.top_p,n:e.n,stop:e.stop,user:e.user,logprobs:e.logprobs,top_logprobs:e.top_logprobs,response_format:e.response_format,seed:e.seed,parallel_tool_calls:e.parallel_tool_calls,web_search_options:e.web_search_options,audio:e.audio,modalities:e.modalities,prediction:e.prediction,reasoning_effort:e.reasoning_effort,metadata:e.metadata,store:e.store};this.log("debug",`${o.REQUEST_BODY} \u539F\u59CB\u8BF7\u6C42\u4F53\u5B57\u6BB5: ${Object.keys(y).filter(_=>y[_]!==void 0).join(", ")}`,"requestBody");let T={};for(let _ of s)y[_]!==void 0&&(T[_]=y[_]);this.log("debug",`${o.REQUEST_BODY} \u767D\u540D\u5355\u8FC7\u6EE4\u540E\u5B57\u6BB5: ${Object.keys(T).join(", ")}`,"requestBody");let b=f(T);this.log("debug",`${o.REQUEST_BODY} \u6DF1\u5EA6\u6E05\u7406\u540E\u5B57\u6BB5: ${Object.keys(b).join(", ")}`,"requestBody"),this.log("info",`${o.REQUEST_BODY} \u5B57\u6BB5\u53D8\u66F4\u7EDF\u8BA1 - \u79FB\u9664: ${d.length}, \u6DFB\u52A0: ${u.length}`,"requestBody"),d.length>0&&this.log("debug",`${o.REQUEST_BODY} \u79FB\u9664\u7684\u5B57\u6BB5: ${d.join(", ")}`,"requestBody"),u.length>0&&this.log("debug",`${o.REQUEST_BODY} \u6DFB\u52A0\u7684\u5B57\u6BB5: ${u.join(", ")}`,"requestBody");let O={"Content-Type":"application/json",Authorization:`Bearer ${t.apiKey}`};this.log("info",`${o.REQUEST_OUT} \u5F00\u59CB\u6784\u5EFA\u8BF7\u6C42 (\u5F3A\u5236\u975E\u6D41\u5F0F\u8BF7\u6C42\uFF0C\u670D\u52A1\u5668\u5C06\u8FD4\u56DE\u975E\u6D41\u5F0F\u54CD\u5E94)`,"requestBody"),this.log("debug",`${o.REQUEST_HEADERS} \u8BF7\u6C42\u5934: Content-Type=${O["Content-Type"]}, Authorization\u957F\u5EA6=${O.Authorization.length}`,"requestBody");let J=`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;return this.persistRequestBody(b,J),this.log("debug",`${o.REQUEST_BODY} \u8BF7\u6C42\u4F53\u5DF2\u6301\u4E45\u5316\u5230debug\u76EE\u5F55\uFF0C\u5B57\u6BB5\u6570\u91CF: ${Object.keys(b).length}`,"requestBody"),{body:b,config:{url:new URL(t.baseUrl),headers:O}}}async transformResponseOut(e){let t=`resp_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,n=p.LOG_PREFIX,o={RESPONSE_IN:`${n} \u{1F4E8} [RESPONSE-IN]`,STREAM_PROCESSING:`${n} \u{1F30A} [STREAM]`,EVENT:`${n} \u{1F4E4} [EVENT]`,ERROR:`${n} \u274C [ERROR]`,INFO:`${n} \u2139\uFE0F [INFO]`,RAW_CHUNK:`${n} \u{1F7E6} [RAW-CHUNK]`,CHUNK_JSON:`${n} \u{1F7E7} [CHUNK-JSON]`,DECODED:`${n} \u{1F7E9} [DECODED]`,RESPONSE_PROCESSING:`${n} \u{1F504} [RESPONSE-PROCESSING]`,CONTENT_ANALYSIS:`${n} \u{1F4CA} [CONTENT-ANALYSIS]`};this.log("info",`${o.RESPONSE_PROCESSING} \u5F00\u59CB\u5904\u7406\u54CD\u5E94 - status: ${e.status}, statusText: ${e.statusText}`,"responseProcessing");let s={};e.headers.forEach((c,r)=>{s[r]=c}),this.log("info",`${o.RESPONSE_IN} \u54CD\u5E94\u5934: `+JSON.stringify(s),"responseProcessing"),this.log("info",`${o.CONTENT_ANALYSIS} \u54CD\u5E94\u5206\u6790 - status: ${e.status}, statusText: ${e.statusText}`,"contentAnalysis"),this.log("info",`${o.CONTENT_ANALYSIS} Content-Type: ${e.headers.get("Content-Type")}`,"contentAnalysis"),this.log("info",`${o.CONTENT_ANALYSIS} Content-Length: ${e.headers.get("Content-Length")}`,"contentAnalysis"),this.log("info",`${o.CONTENT_ANALYSIS} Transfer-Encoding: ${e.headers.get("Transfer-Encoding")}`,"contentAnalysis");let l=e.headers.get("Content-Type")||"";if(this.log("debug",`${o.CONTENT_ANALYSIS} \u54CD\u5E94Content-Type: ${l}`,"contentAnalysis"),e.status===206&&l.includes("application/json")){this.log("info",`${o.RESPONSE_PROCESSING} \u68C0\u6D4B\u5230206\u72B6\u6001\u7801\u7684JSON\u54CD\u5E94\uFF0C\u5C1D\u8BD5\u4F5C\u4E3AJSON\u54CD\u5E94\u5904\u7406`,"responseProcessing");try{let r=await e.clone().json();if(this.log("info",`${o.RAW_CHUNK} 206\u54CD\u5E94\u5B9E\u9645\u5185\u5BB9: ${JSON.stringify(r)}`,"rawData"),this.persistResponseBody(r,t,e.status),r&&r.error)return this.log("error",`${o.ERROR} 206\u54CD\u5E94\u5305\u542B\u9519\u8BEF\u4FE1\u606F: ${r.error.message}`,"responseProcessing"),new Response(JSON.stringify(r),{status:200,statusText:"OK",headers:{"Content-Type":"application/json",...e.headers}});if(r&&typeof r=="object")return this.log("info",`${o.RESPONSE_PROCESSING} 206\u54CD\u5E94\u5B9E\u9645\u662FJSON\u683C\u5F0F\uFF0C\u6309JSON\u54CD\u5E94\u5904\u7406`,"responseProcessing"),this.handleJsonResponse(e,r)}catch(c){return this.log("error",`${o.ERROR} 206\u54CD\u5E94JSON\u89E3\u6790\u5931\u8D25: ${c}`,"responseProcessing"),e}}if(l.includes("stream")){if(this.log("info",`${o.STREAM_PROCESSING} \u68C0\u6D4B\u5230\u771F\u6B63\u7684\u6D41\u5F0F\u54CD\u5E94 (status: ${e.status}, contentType: ${l})\uFF0C\u5F00\u59CB\u6807\u51C6OpenAI\u6D41\u5F0F\u8F93\u51FA`,"streamProcessing"),!e.body)return this.log("error",`${o.ERROR} \u6D41\u5F0F\u54CD\u5E94\u4F46body\u4E3A\u7A7A`,"streamProcessing"),e;let c=new TextDecoder,r=new TextEncoder,a=0,d=this,u=new ReadableStream({async start(m){let h=e.body.getReader();try{for(d.log("info",`${o.STREAM_PROCESSING} \u5F00\u59CB\u8BFB\u53D6\u6D41\u5F0F\u6570\u636E`,"streamProcessing");;){let{done:f,value:R}=await h.read();if(f){d.log("info",`${o.STREAM_PROCESSING} \u6D41\u5F0F\u8BFB\u53D6\u5B8C\u6210`,"streamProcessing");break}let y=c.decode(R,{stream:!0});d.log("verbose",`${o.RAW_CHUNK} \u539F\u59CBchunk\u6570\u636E: ${JSON.stringify(y)}`,"rawData");let T=y.split(`
`);d.log("debug",`${o.STREAM_PROCESSING} \u5206\u5272\u540E\u884C\u6570: ${T.length}`,"streamProcessing");for(let b of T)if(b.startsWith("data: ")&&b.trim()!=="data: [DONE]")try{let O=JSON.parse(b.slice(6));if(d.log("verbose",`${o.RAW_CHUNK} \u89E3\u6790chunk\u6570\u636E: ${JSON.stringify(O)}`,"rawData"),!O||!O.choices||!Array.isArray(O.choices)||O.choices.length===0){d.log("error",`${o.ERROR} chunk\u6570\u636E\u683C\u5F0F\u5F02\u5E38: choices\u5B57\u6BB5\u7F3A\u5931\u6216\u4E3A\u7A7A`,"streamProcessing"),m.enqueue(r.encode(b+`
`));continue}let J=O.choices?.[0]?.delta?.content;if(d.log("debug",`${o.CHUNK_JSON} \u63D0\u53D6content: ${typeof J} - ${J}`,"chunkProcessing"),typeof J=="string"&&J.length>0){let _={choices:[{delta:{...a===0?{role:"assistant"}:{},content:J},index:a,finish_reason:null}],created:O.created||Math.floor(Date.now()/1e3),id:O.id||"",model:O.model||"",object:"chat.completion.chunk"};d.log("debug",`${o.DECODED} \u53D1\u9001chunk ${a}: ${JSON.stringify(_)}`,"chunkProcessing"),m.enqueue(r.encode(`data: ${JSON.stringify(_)}

`)),a++}else d.log("debug",`${o.INFO} \u8DF3\u8FC7\u7A7Acontent\u7684chunk`,"chunkProcessing")}catch(O){d.log("error",`${o.ERROR} chunk\u89E3\u6790\u5931\u8D25: ${O}`,"streamProcessing"),m.enqueue(r.encode(b+`
`))}else m.enqueue(r.encode(b+`
`))}d.log("info",`${o.INFO} \u6D41\u5F0F\u5904\u7406\u5B8C\u6210\uFF0C\u53D1\u9001\u7ED3\u675Fchunk - \u603Bchunk\u6570: ${a}`,"streamProcessing");let g={choices:[{delta:{},index:a,finish_reason:"stop"}],created:Math.floor(Date.now()/1e3),id:`done_${Date.now()}`,model:"zjcspace",object:"chat.completion.chunk"};m.enqueue(r.encode(`data: ${JSON.stringify(g)}

`)),m.enqueue(r.encode(`data: [DONE]

`))}catch(g){d.log("error",`${o.ERROR} \u6D41\u5F0F\u5904\u7406\u5F02\u5E38: ${g}`,"streamProcessing"),m.error(g)}finally{try{h.releaseLock()}catch{}m.close()}}});return new Response(u,{status:e.status,statusText:e.statusText,headers:{"Content-Type":e.headers.get("Content-Type")||"text/plain","Cache-Control":"no-cache",Connection:"keep-alive"}})}if(l.includes("application/json")){this.log("info",`${o.RESPONSE_PROCESSING} \u68C0\u6D4B\u5230JSON\u54CD\u5E94\uFF0C\u5F00\u59CB\u5904\u7406`,"responseProcessing");let c;try{c=await e.json(),this.log("info",`${o.INFO} \u54CD\u5E94\u5185\u5BB9: ${JSON.stringify(c)}`,"rawData")}catch(a){return this.log("error",`${o.ERROR} \u54CD\u5E94\u4F53\u89E3\u6790\u5931\u8D25: ${a}`,"responseProcessing"),e}if(!c||!c.choices||!Array.isArray(c.choices)||c.choices.length===0)return this.log("error",`${o.ERROR} \u54CD\u5E94\u683C\u5F0F\u5F02\u5E38: choices \u5B57\u6BB5\u7F3A\u5931\u6216\u4E3A\u7A7A`,"responseProcessing"),e;this.log("info",`${o.CONTENT_ANALYSIS} \u54CD\u5E94\u683C\u5F0F\u6B63\u5E38 - choices\u6570\u91CF: ${c.choices.length}`,"contentAnalysis");let r=c.choices?.[0]?.message?.content;if(this.log("debug",`${o.CONTENT_ANALYSIS} \u63D0\u53D6message content: ${typeof r} - \u957F\u5EA6: ${typeof r=="string"?r.length:"N/A"}`,"contentAnalysis"),typeof r=="string"){let a=r.match(/```json\n([\s\S]*?)\n```/);a&&a[1]&&c.choices?.[0]?.message?(this.log("info",`${o.CONTENT_ANALYSIS} \u68C0\u6D4B\u5230JSON\u4EE3\u7801\u5757\uFF0C\u8FDB\u884C\u5185\u5BB9\u6E05\u6D17`,"contentAnalysis"),c.choices[0].message.content=a[1]):this.log("debug",`${o.CONTENT_ANALYSIS} \u672A\u68C0\u6D4B\u5230JSON\u4EE3\u7801\u5757\uFF0C\u4FDD\u6301\u539F\u59CB\u5185\u5BB9`,"contentAnalysis")}return this.log("info",`${o.RESPONSE_PROCESSING} JSON\u54CD\u5E94\u5904\u7406\u5B8C\u6210\uFF0C\u8FD4\u56DE\u5904\u7406\u540E\u7684\u54CD\u5E94`,"responseProcessing"),new Response(JSON.stringify(c),{status:e.status,statusText:e.statusText,headers:e.headers})}return this.log("info",`${o.RESPONSE_PROCESSING} \u975EJSON/\u975E\u6D41\u5F0F\u54CD\u5E94\uFF0C\u76F4\u63A5\u900F\u4F20`,"responseProcessing"),e}handleJsonResponse(e,t){let n=p.LOG_PREFIX,o={RESPONSE_PROCESSING:`${n} \u{1F504} [RESPONSE-PROCESSING]`,CONTENT_ANALYSIS:`${n} \u{1F4CA} [CONTENT-ANALYSIS]`,ERROR:`${n} \u274C [ERROR]`};this.log("info",`${o.RESPONSE_PROCESSING} \u5904\u7406JSON\u54CD\u5E94`,"responseProcessing");let s=`resp_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;if(this.persistResponseBody(t,s,e.status),!t||!t.choices||!Array.isArray(t.choices)||t.choices.length===0)return this.log("error",`${o.ERROR} JSON\u54CD\u5E94\u683C\u5F0F\u5F02\u5E38: choices \u5B57\u6BB5\u7F3A\u5931\u6216\u4E3A\u7A7A`,"responseProcessing"),e;this.log("info",`${o.CONTENT_ANALYSIS} JSON\u54CD\u5E94\u683C\u5F0F\u6B63\u5E38 - choices\u6570\u91CF: ${t.choices.length}`,"contentAnalysis");let l=t.choices?.[0]?.message?.content;if(this.log("debug",`${o.CONTENT_ANALYSIS} \u63D0\u53D6message content: ${typeof l} - \u957F\u5EA6: ${typeof l=="string"?l.length:"N/A"}`,"contentAnalysis"),typeof l=="string"){let c=l.match(/```json\n([\s\S]*?)\n```/);c&&c[1]&&t.choices?.[0]?.message?(this.log("info",`${o.CONTENT_ANALYSIS} \u68C0\u6D4B\u5230JSON\u4EE3\u7801\u5757\uFF0C\u8FDB\u884C\u5185\u5BB9\u6E05\u6D17`,"contentAnalysis"),t.choices[0].message.content=c[1]):this.log("debug",`${o.CONTENT_ANALYSIS} \u672A\u68C0\u6D4B\u5230JSON\u4EE3\u7801\u5757\uFF0C\u4FDD\u6301\u539F\u59CB\u5185\u5BB9`,"contentAnalysis")}return this.log("info",`${o.RESPONSE_PROCESSING} JSON\u54CD\u5E94\u5904\u7406\u5B8C\u6210\uFF0C\u8FD4\u56DE\u5904\u7406\u540E\u7684\u54CD\u5E94`,"responseProcessing"),new Response(JSON.stringify(t),{status:e.status,statusText:e.statusText,headers:e.headers})}};var It=[new ee,new Z,new X,new Q,new ne,new te,new oe,new re,new se];var ge=class{constructor(e){this.configService=e;this.initialize()}transformers=new Map;registerTransformer(e,t){this.transformers.set(e,t),i(`register transformer: ${e}${t.endPoint?` (endpoint: ${t.endPoint})`:" (no endpoint)"}`)}getTransformer(e){return this.transformers.get(e)}getAllTransformers(){return new Map(this.transformers)}getTransformersWithEndpoint(){let e=[];return this.transformers.forEach((t,n)=>{t.endPoint&&e.push({name:n,transformer:t})}),e}getTransformersWithoutEndpoint(){let e=[];return this.transformers.forEach((t,n)=>{t.endPoint||e.push({name:n,transformer:t})}),e}removeTransformer(e){return this.transformers.delete(e)}hasTransformer(e){return this.transformers.has(e)}async registerTransformerFromConfig(e){try{if(e.path){let t=Ee(e.path);if(t){let n=new t(e.options);if(!n.name)throw new Error(`Transformer instance from ${e.path} does not have a name property.`);return this.registerTransformer(n.name,n),!0}}return!1}catch(t){return i(`load transformer (${e.path}):`,t),!1}}async initialize(){try{await this.registerDefaultTransformersInternal(),await this.loadFromConfig()}catch(e){i("TransformerService init error:",e)}}async registerDefaultTransformersInternal(){try{let e=new ce,t=new X,n=new Q,o=new Z,s=new le,l=new ee,c=new te,r=new ne,a=new oe,d=new re({logLevel:"verbose",logCategories:{rawData:!0,chunkProcessing:!0}}),u=new se;this.registerTransformer(e.name,e),this.registerTransformer(t.name,t),this.registerTransformer(n.name,n),this.registerTransformer(o.name,o),this.registerTransformer(s.name,s),this.registerTransformer(l.name,l),this.registerTransformer(c.name,c),this.registerTransformer(r.name,r),this.registerTransformer(a.name,a),this.registerTransformer(d.name,d),this.registerTransformer(u.name,u)}catch(e){i("transformer regist error:",e)}}async loadFromConfig(){let e=this.configService.get("transformers",[]);for(let t of e)await this.registerTransformerFromConfig(t)}};var he=class{pendingRequests=new Map;mergeWindow=2e3;maxMergeSize=5;mergeTimer=null;constructor(){i("\u{1F504} \u8BF7\u6C42\u5408\u5E76\u5668\u5DF2\u542F\u52A8\uFF0C\u5408\u5E76\u7A97\u53E3: 2\u79D2, \u6700\u5927\u5408\u5E76\u6570: 5")}addRequest(e,t,n,o,s){let l={id:e,request:t,reply:n,timestamp:Date.now(),resolved:!1,config:o,url:s};if(this.pendingRequests.set(e,l),i(`\u{1F4E5} \u6536\u5230\u8BF7\u6C42 ${e}\uFF0C\u5F53\u524D\u961F\u5217\u957F\u5EA6: ${this.pendingRequests.size}`),this.pendingRequests.size>=this.maxMergeSize){i(`\u{1F680} \u8FBE\u5230\u6700\u5927\u5408\u5E76\u6570\u91CF(${this.maxMergeSize})\uFF0C\u7ACB\u5373\u5904\u7406`),this.processPendingRequests();return}this.mergeTimer&&clearTimeout(this.mergeTimer),this.mergeTimer=setTimeout(()=>{this.processPendingRequests()},this.mergeWindow)}async processPendingRequests(){if(this.pendingRequests.size===0)return;let e=Array.from(this.pendingRequests.values());this.pendingRequests.clear(),this.mergeTimer&&(clearTimeout(this.mergeTimer),this.mergeTimer=null),i(`\u{1F504} \u5F00\u59CB\u5904\u7406 ${e.length} \u4E2A\u5F85\u5904\u7406\u8BF7\u6C42`);let n=this.groupRequestsByProvider(e).map(o=>this.processGroup(o));await Promise.all(n)}groupRequestsByProvider(e){let t=new Map;for(let n of e){let o=`${n.url}_${n.request.model}`;t.has(o)||t.set(o,[]),t.get(o).push(n)}return Array.from(t.values())}async processGroup(e){if(e.length===1){await this.processSingleRequest(e[0]);return}i(`\u{1F500} \u5408\u5E76\u5904\u7406 ${e.length} \u4E2A\u76F8\u540C\u63D0\u4F9B\u5546\u7684\u8BF7\u6C42`);let t=this.attemptMerge(e);if(t)await this.processMergedRequest(t,e);else{i("\u26A0\uFE0F  \u65E0\u6CD5\u5408\u5E76\u8BF7\u6C42\uFF0C\u5C06\u5355\u72EC\u5904\u7406");let n=e.map(o=>this.processSingleRequest(o));await Promise.all(n)}}attemptMerge(e){let t=e[0].request,n=this.extractSystemMessages(t.messages);if(!e.every(r=>{let a=this.extractSystemMessages(r.request.messages);return this.messagesEqual(n,a)}))return null;let s=[...n],l=[];for(let r of e){let a=this.extractUserMessages(r.request.messages),d=s.length;s.push({role:"user",content:`--- \u8BF7\u6C42 ${r.id} \u5F00\u59CB ---`}),s.push(...a),s.push({role:"user",content:`--- \u8BF7\u6C42 ${r.id} \u7ED3\u675F ---`});let u=s.length-1;l.push({id:r.id,startIndex:d,endIndex:u,originalMessages:a})}let c={...t,messages:s,max_tokens:Math.min((t.max_tokens||4096)*e.length,16384)};return i(`\u2705 \u6210\u529F\u5408\u5E76 ${e.length} \u4E2A\u8BF7\u6C42\uFF0C\u603B\u6D88\u606F\u6570: ${s.length}`),{baseRequest:c,subRequests:l}}async processMergedRequest(e,t){try{let n=t[0].config,o=t[0].url;i(`\u{1F680} \u53D1\u9001\u5408\u5E76\u8BF7\u6C42\uFF0C\u5305\u542B ${e.subRequests.length} \u4E2A\u5B50\u8BF7\u6C42`);let s=await ae(o,e.baseRequest,n);if(!s.ok)throw new Error(`\u5408\u5E76\u8BF7\u6C42\u5931\u8D25: ${s.status} ${s.statusText}`);e.baseRequest.stream?await this.handleMergedStreamResponse(s,e,t):await this.handleMergedResponse(s,e,t)}catch(n){i(`\u274C \u5408\u5E76\u8BF7\u6C42\u5904\u7406\u5931\u8D25: ${n.message}`);let o=t.map(s=>this.processSingleRequest(s));await Promise.all(o)}}async handleMergedResponse(e,t,n){let o=await e.json(),s=o.choices?.[0]?.message?.content||"",l=this.splitMergedResponse(s,t.subRequests);for(let c=0;c<n.length;c++){let r=n[c],a=l[c]||"\u5904\u7406\u5931\u8D25",d={...o,choices:[{...o.choices[0],message:{...o.choices[0].message,content:a}}]};r.reply.send(d),i(`\u{1F4E4} \u5DF2\u53D1\u9001\u54CD\u5E94\u7ED9\u8BF7\u6C42 ${r.id}`)}}async handleMergedStreamResponse(e,t,n){i("\u26A0\uFE0F  \u5408\u5E76\u6D41\u5F0F\u54CD\u5E94\u5904\u7406\u8F83\u590D\u6742\uFF0C\u6682\u65F6\u5355\u72EC\u5904\u7406");let o=n.map(s=>this.processSingleRequest(s));await Promise.all(o)}async processSingleRequest(e){try{i(`\u{1F504} \u5355\u72EC\u5904\u7406\u8BF7\u6C42 ${e.id}`);let t=await ae(e.url,e.request,e.config);if(!t.ok)throw new Error(`\u8BF7\u6C42\u5931\u8D25: ${t.status} ${t.statusText}`);if(e.request.stream)e.reply.header("Content-Type","text/event-stream"),e.reply.header("Cache-Control","no-cache"),e.reply.header("Connection","keep-alive"),e.reply.send(t.body);else{let n=await t.json();e.reply.send(n)}i(`\u2705 \u8BF7\u6C42 ${e.id} \u5904\u7406\u5B8C\u6210`)}catch(t){i(`\u274C \u8BF7\u6C42 ${e.id} \u5904\u7406\u5931\u8D25: ${t.message}`),e.reply.code(500).send({error:t.message})}}extractSystemMessages(e){return e.filter(t=>t.role==="system")}extractUserMessages(e){return e.filter(t=>t.role!=="system")}messagesEqual(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++){let o=e[n],s=t[n];if(o.role!==s.role||o.content!==s.content)return!1}return!0}splitMergedResponse(e,t){let n=[];for(let o of t){let s=`--- \u8BF7\u6C42 ${o.id} \u5F00\u59CB ---`,l=`--- \u8BF7\u6C42 ${o.id} \u7ED3\u675F ---`,c=e.indexOf(s),r=e.indexOf(l);if(c!==-1&&r!==-1){let a=e.substring(c+s.length,r).trim();n.push(a)}else n.push("")}return n}getStats(){return{pendingRequests:this.pendingRequests.size,mergeWindow:this.mergeWindow,maxMergeSize:this.maxMergeSize}}};function Le(){let p=xe({});return p.setErrorHandler($e),p.register(we),p}var Se=class{app;configService;llmService;providerService;transformerService;requestMergerService;constructor(e={}){this.configService=new fe(e),this.providerService=new pe(this.configService),this.llmService=new ue(this.providerService),this.transformerService=new ge(this.configService),this.requestMergerService=new he,this.app=Le()}async register(e,t){await this.app.register(e,t)}addHook(e,t){this.app.addHook(e,t)}async start(){try{this.app._server=this,this.app.addHook("preHandler",async(n,o)=>{try{let s=n.body;if(!s||!s.model)return o.code(400).send({error:"Missing model in request body"});let[l,c]=s.model.split(",");s.model=c,n.provider=l;return}catch(s){return n.log.error("Error in modelProviderMiddleware:",s),o.code(500).send({error:"Internal server error"})}}),this.app.register(Ne);let e=await this.app.listen({port:parseInt(this.configService.get("PORT")||"3000",10),host:this.configService.get("HOST")||"127.0.0.1"});i(`\u{1F680} LLMs API server listening on ${e}`);let t=async n=>{i(`Received ${n}, shutting down gracefully...`),await this.app.close(),process.exit(0)};process.on("SIGINT",()=>t("SIGINT")),process.on("SIGTERM",()=>t("SIGTERM"))}catch(e){i(`Error starting server: ${e}`),process.exit(1)}}},_n=Se;export{_n as default};
//# sourceMappingURL=server.mjs.map
